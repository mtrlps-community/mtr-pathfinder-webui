{% extends 'base.html' %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- å·¦ä¾§ï¼šå¯»è·¯è¡¨å• -->
    <div class="lg:col-span-1">
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">è·¯å¾„æŸ¥æ‰¾</h2>
            
            <!-- ç®€ç åŠŸèƒ½ -->
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <label class="block text-gray-700 font-medium mr-2" for="shortcode">
                        <i class="fa fa-code mr-1"></i> ç®€ç è¾“å…¥
                    </label>
                    <button type="button" class="text-blue-500 text-sm hover:underline" id="shortcode-help">
                        æ ¼å¼è¯´æ˜
                    </button>
                </div>
                <div class="relative">
                    <textarea id="shortcode" class="form-input" placeholder="/è·¯çº¿ <å‡ºå‘ç«™>;<åˆ°è¾¾ç«™>;[è¯¦ç»†];[ç†è®º];[è¶Šé‡];[ç¦é«˜é“];[ç¦èˆ¹];[ä»…è½»é“];[ç¦è·¯çº¿;<è·¯çº¿>;<è·¯çº¿> ...];[ç¦è½¦ç«™;<è½¦ç«™>;<è½¦ç«™> ...]]"></textarea>
                </div>
                <!-- ç®€ç æ ¼å¼è¯´æ˜å¼¹çª— -->
                <div id="shortcode-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg max-w-lg w-full mx-4">
                        <h3 class="text-xl font-bold mb-4">ç®€ç æ ¼å¼è¯´æ˜</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold mb-2">è°ƒç”¨æ ¼å¼ï¼š</h4>
                                <p class="bg-gray-100 p-3 rounded break-all">/è·¯çº¿ <å‡ºå‘ç«™>;<åˆ°è¾¾ç«™>;[è¯¦ç»†];[ç†è®º];[è¶Šé‡];[ç¦é«˜é“];[ç¦èˆ¹];[ä»…è½»é“];[ç¦è·¯çº¿;<è·¯çº¿>;<è·¯çº¿> ...];[ç¦è½¦ç«™;<è½¦ç«™>;<è½¦ç«™> ...]]</p>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">å…¶ä»–å‚æ•°ï¼š</h4>
                                <ul class="list-disc pl-5 space-y-2">
                                    <li><strong>é»˜è®¤</strong> -> å®é™…èƒ½åçš„æœ€å¿«è·¯çº¿ï¼ˆè®¡ç®—ç­‰è½¦æ—¶é—´ï¼‰ï¼Œä»¥å›¾ç‰‡å½¢å¼è¾“å‡ºå¯»è·¯ç»“æœ</li>
                                    <li><strong>å®æ—¶</strong> -> å®æ—¶å¯»è·¯ï¼ˆé€‚ç”¨äº LPS 4.0.0 æµ‹è¯•æœåŠ¡å™¨ï¼‰</li>
                                    <li><strong>è¯¦ç»†</strong> -> è¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬çº¿è·¯é—´éš”ä»¥åŠæ¯ä¸€ç«™çš„ç­‰è½¦æ—¶é—´</li>
                                    <li><strong>ç†è®º</strong> -> ç†è®ºæœ€å¿«è·¯çº¿ï¼Œä¸è€ƒè™‘çº¿è·¯ä¸Šæ˜¯å¦æœ‰è½¦åœ¨è·‘</li>
                                    <li><strong>è¶Šé‡</strong> -> å…è®¸åœ¨ä¸¤ä¸ªè½¦ç«™é—´æ­¥è¡Œï¼Œæœ€å¤§èŒƒå›´ä¸º 1500 æ ¼</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2">æ³¨æ„äº‹é¡¹ï¼š</h4>
                                <ul class="list-disc pl-5 space-y-2">
                                    <li>&lt;&gt; å¿…å¡«ï¼Œ[] é€‰å¡«</li>
                                    <li>â€œï¼›â€ã€â€œ;â€ éƒ½å¯ä»¥ä½¿ç”¨</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="close-modal" class="btn-primary">å…³é—­</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <form id="route-form">
                <!-- èµ·ç‚¹ç«™ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="start-station">
                        <i class="fa fa-map-marker mr-1"></i> èµ·ç‚¹ç«™
                    </label>
                    <div class="relative">
                        <textarea id="start-station" name="start" class="form-input" placeholder="è¾“å…¥èµ·ç‚¹ç«™åç§°" required></textarea>
                        <div id="start-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden"></div>
                    </div>
                </div>
                
                <!-- ç»ˆç‚¹ç«™ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="end-station">
                        <i class="fa fa-flag mr-1"></i> ç»ˆç‚¹ç«™
                    </label>
                    <div class="relative">
                        <textarea id="end-station" name="end" class="form-input" placeholder="è¾“å…¥ç»ˆç‚¹ç«™åç§°" required></textarea>
                        <div id="end-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden"></div>
                    </div>
                </div>
                
                <!-- ç¦è·¯çº¿ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="ignored-lines">
                        <i class="fa fa-ban mr-1"></i> ç¦è·¯çº¿ï¼ˆåˆ†å·åˆ†éš”ï¼‰
                    </label>
                    <textarea id="ignored-lines" name="ignored_lines" class="form-input" placeholder="è¾“å…¥è¦ç¦æ­¢çš„è·¯çº¿ï¼Œä»¥åˆ†å·åˆ†éš”"></textarea>
                </div>
                
                <!-- ç¦è½¦ç«™ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="avoid-stations">
                        <i class="fa fa-ban mr-1"></i> ç¦è½¦ç«™ï¼ˆåˆ†å·åˆ†éš”ï¼‰
                    </label>
                    <textarea id="avoid-stations" name="avoid_stations" class="form-input" placeholder="è¾“å…¥è¦é¿å¼€çš„è½¦ç«™ï¼Œä»¥åˆ†å·åˆ†éš”"></textarea>
                </div>
                
                <!-- å¯»è·¯è®¾ç½® -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">å¯»è·¯è®¾ç½®</h3>
                    
                    <div class="route-settings flex flex-wrap gap-4">
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="disable-high-speed" name="disable_high_speed" class="form-checkbox">
                            <span class="ml-2 text-gray-700">ç¦é«˜é“</span>
                        </label>
                        
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="disable-boat" name="disable_boat" class="form-checkbox">
                            <span class="ml-2 text-gray-700">ç¦èˆ¹</span>
                        </label>
                        
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="enable-wild" name="enable_wild" class="form-checkbox">
                            <span class="ml-2 text-gray-700">è¶Šé‡</span>
                        </label>
                        
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="only-lrt" name="only_lrt" class="form-checkbox">
                            <span class="ml-2 text-gray-700">ä»…è½»è½¨</span>
                        </label>
                    </div>
                </div>
                
                <!-- å¯»è·¯ç®—æ³•é€‰æ‹© -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">å¯»è·¯ç®—æ³•</h3>
                    
                    <div class="algorithm-tabs">
                        <div class="flex overflow-x-auto no-scrollbar">
                            <div class="algorithm-tab active" data-index="0" data-value="default">é»˜è®¤</div>
                            <div class="algorithm-tab" data-index="1" data-value="theory">ç†è®º</div>
                            <div class="algorithm-tab" data-index="2" data-value="real">å®æ—¶</div>
                        </div>
                        <div class="mt-2 text-center font-medium text-blue-500" id="algorithm-display">é»˜è®¤ï¼ˆè€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰</div>
                        <input type="hidden" id="algorithm" name="algorithm" value="default">
                    </div>
                </div>
                
                <!-- æŸ¥æ‰¾æŒ‰é’® -->
                <div class="flex space-x-3">
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fa fa-search mr-2"></i> æŸ¥æ‰¾è·¯å¾„
                    </button>
                    <button type="reset" class="btn-secondary">
                        <i class="fa fa-refresh mr-2"></i> é‡ç½®
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- å³ä¾§ï¼šç»“æœå±•ç¤º -->
    <div class="lg:col-span-2">
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">è·¯å¾„ç»“æœ</h2>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="hidden py-12">
                <div class="max-w-md mx-auto">
                    <h3 class="text-lg font-semibold mb-4 text-center">æ­£åœ¨è®¡ç®—è·¯å¾„</h3>
                    <div class="mb-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span id="progress-stage">å‡†å¤‡ä¸­...</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                    </div>
                    <div id="progress-message" class="text-center text-gray-500 text-sm"></div>
                </div>
            </div>
            
            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4"></div>
            
            <!-- ç»“æœåŒºåŸŸ -->
            <div id="result" class="hidden">
                <!-- è¯¦ç»†è·¯å¾„ -->
                <div id="route-details" class="space-y-4">
                    <!-- è·¯å¾„æ­¥éª¤å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- ç»“æœå›¾åƒ -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3">è·¯å¾„å›¾åƒ</h3>
                    <div id="route-image" class="border border-gray-300 rounded-lg p-4 bg-white">
                        <p class="text-gray-500 text-center">è·¯å¾„å›¾åƒå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                </div>
            </div>
            
            <!-- æ— ç»“æœçŠ¶æ€ -->
            <div id="no-result" class="hidden text-center py-12">
                <i class="fa fa-route text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">æœªæ‰¾åˆ°è·¯å¾„</h3>
                <p class="text-gray-500">è¯·æ£€æŸ¥è¾“å…¥å‚æ•°æˆ–å°è¯•å…¶ä»–ç®—æ³•</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ç®—æ³•æ˜ å°„
    const algorithmMap = [
        { value: 'default', label: 'é»˜è®¤ï¼ˆè€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰' },
        { value: 'theory', label: 'ç†è®ºï¼ˆä¸è€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰' },
        { value: 'real', label: 'å®æ—¶' }
    ];
    
    // ç®€ç åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        // ç®€ç æ ¼å¼è¯´æ˜å¼¹çª—
        const shortcodeHelpBtn = document.getElementById('shortcode-help');
        const shortcodeModal = document.getElementById('shortcode-modal');
        const closeModalBtn = document.getElementById('close-modal');
        
        shortcodeHelpBtn.addEventListener('click', function() {
            shortcodeModal.classList.remove('hidden');
        });
        
        closeModalBtn.addEventListener('click', function() {
            shortcodeModal.classList.add('hidden');
        });
        
        shortcodeModal.addEventListener('click', function(e) {
            if (e.target === shortcodeModal) {
                shortcodeModal.classList.add('hidden');
            }
        });
        
        // ç®€ç è¾“å…¥æ¡†
        const shortcodeInput = document.getElementById('shortcode');
        
        // è¡¨å•å…ƒç´ 
        const startStationInput = document.getElementById('start-station');
        const endStationInput = document.getElementById('end-station');
        const ignoredLinesInput = document.getElementById('ignored-lines');
        const avoidStationsInput = document.getElementById('avoid-stations');
        const disableHighSpeedCheckbox = document.getElementById('disable-high-speed');
        const disableBoatCheckbox = document.getElementById('disable-boat');
        const enableWildCheckbox = document.getElementById('enable-wild');
        const onlyLrtCheckbox = document.getElementById('only-lrt');
        const algorithmInput = document.getElementById('algorithm');
        const algorithmDisplay = document.getElementById('algorithm-display');
        
        // è§£æç®€ç å¹¶å¡«å……åˆ°è¡¨å•
        function parseShortcode(shortcode) {
            // é‡ç½®è¡¨å•
            startStationInput.value = '';
            endStationInput.value = '';
            ignoredLinesInput.value = '';
            avoidStationsInput.value = '';
            disableHighSpeedCheckbox.checked = false;
            disableBoatCheckbox.checked = false;
            enableWildCheckbox.checked = false;
            onlyLrtCheckbox.checked = false;
            algorithmInput.value = 'default';
            algorithmDisplay.textContent = 'é»˜è®¤ï¼ˆè€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰';
            
            // ç§»é™¤ç®—æ³•é€‰é¡¹å¡çš„activeç±»
            document.querySelectorAll('.algorithm-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // è®¾ç½®é»˜è®¤ç®—æ³•é€‰é¡¹å¡ä¸ºactive
            document.querySelector('.algorithm-tab[data-value="default"]').classList.add('active');
            
            // é‡ç½®åè°ƒæ•´æ‰€æœ‰è¾“å…¥æ¡†é«˜åº¦
            if (window.autoResizeTextarea) {
                window.autoResizeTextarea(startStationInput);
                window.autoResizeTextarea(endStationInput);
                window.autoResizeTextarea(ignoredLinesInput);
                window.autoResizeTextarea(avoidStationsInput);
            }
            
            // è§£æç®€ç 
            if (!shortcode.startsWith('/è·¯çº¿')) {
                return;
            }
            
            // ç§»é™¤å‰ç¼€
            const content = shortcode.replace(/^\/è·¯çº¿\s*/, '');
            // ç»Ÿä¸€åˆ†éš”ç¬¦
            const parts = content.split(/[ï¼›;]/).map(part => part.trim()).filter(Boolean);
            
            if (parts.length < 2) {
                return;
            }
            
            // å‡ºå‘ç«™å’Œåˆ°è¾¾ç«™
            startStationInput.value = parts[0].replace(/^<|>$/g, '');
            endStationInput.value = parts[1].replace(/^<|>$/g, '');
            
            // è°ƒæ•´å‡ºå‘ç«™å’Œåˆ°è¾¾ç«™è¾“å…¥æ¡†é«˜åº¦
            if (window.autoResizeTextarea) {
                window.autoResizeTextarea(startStationInput);
                window.autoResizeTextarea(endStationInput);
            }
            
            // å¤„ç†å…¶ä»–å‚æ•°
            let i = 2;
            while (i < parts.length) {
                const part = parts[i];
                
                switch (part) {
                    case 'è¯¦ç»†':
                        // è¯¦ç»†ä¿¡æ¯æš‚ä¸å¤„ç†ï¼Œå› ä¸ºå‰ç«¯æ²¡æœ‰å¯¹åº”çš„é€‰é¡¹
                        i++;
                        break;
                    case 'ç†è®º':
                        algorithmInput.value = 'theory';
                        algorithmDisplay.textContent = 'ç†è®ºï¼ˆä¸è€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰';
                        document.querySelectorAll('.algorithm-tab').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        document.querySelector('.algorithm-tab[data-value="theory"]').classList.add('active');
                        i++;
                        break;
                    case 'å®æ—¶':
                        algorithmInput.value = 'real';
                        algorithmDisplay.textContent = 'å®æ—¶';
                        document.querySelectorAll('.algorithm-tab').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        document.querySelector('.algorithm-tab[data-value="real"]').classList.add('active');
                        i++;
                        break;
                    case 'è¶Šé‡':
                        enableWildCheckbox.checked = true;
                        i++;
                        break;
                    case 'ç¦é«˜é“':
                        disableHighSpeedCheckbox.checked = true;
                        i++;
                        break;
                    case 'ç¦èˆ¹':
                        disableBoatCheckbox.checked = true;
                        i++;
                        break;
                    case 'ä»…è½»é“':
                        onlyLrtCheckbox.checked = true;
                        i++;
                        break;
                    case 'ç¦è·¯çº¿':
                        // å¤„ç†ç¦è·¯çº¿ï¼Œæ”¶é›†åç»­æ‰€æœ‰è·¯çº¿ç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå…³é”®å­—
                        i++;
                        const routeLines = [];
                        // æ”¶é›†æ‰€æœ‰åç»­çš„è·¯çº¿ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå…³é”®å­—
                        while (i < parts.length && !['ç¦è½¦ç«™', 'è¯¦ç»†', 'ç†è®º', 'å®æ—¶', 'è¶Šé‡', 'ç¦é«˜é“', 'ç¦èˆ¹', 'ä»…è½»é“'].includes(parts[i])) {
                            routeLines.push(parts[i]);
                            i++;
                        }
                        ignoredLinesInput.value = routeLines.join(';');
                        
                        // è°ƒæ•´ç¦è·¯çº¿è¾“å…¥æ¡†é«˜åº¦
                        if (window.autoResizeTextarea) {
                            window.autoResizeTextarea(ignoredLinesInput);
                        }
                        break;
                    case 'ç¦è½¦ç«™':
                        // å¤„ç†ç¦è½¦ç«™ï¼Œæ”¶é›†åç»­æ‰€æœ‰è½¦ç«™ç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå…³é”®å­—
                        i++;
                        const avoidStations = [];
                        // æ”¶é›†æ‰€æœ‰åç»­çš„è½¦ç«™ï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªå…³é”®å­—
                        while (i < parts.length && !['ç¦è·¯çº¿', 'è¯¦ç»†', 'ç†è®º', 'å®æ—¶', 'è¶Šé‡', 'ç¦é«˜é“', 'ç¦èˆ¹', 'ä»…è½»é“'].includes(parts[i])) {
                            avoidStations.push(parts[i]);
                            i++;
                        }
                        avoidStationsInput.value = avoidStations.join(';');
                        
                        // è°ƒæ•´ç¦è½¦ç«™è¾“å…¥æ¡†é«˜åº¦
                        if (window.autoResizeTextarea) {
                            window.autoResizeTextarea(avoidStationsInput);
                        }
                        break;
                    default:
                        // å¿½ç•¥æœªçŸ¥å‚æ•°
                        i++;
                        break;
                }
            }
        }
        
        // ç”Ÿæˆç®€ç 
        function generateShortcode() {
            let shortcode = '/è·¯çº¿ ';
            
            // å‡ºå‘ç«™å’Œåˆ°è¾¾ç«™
            shortcode += `${startStationInput.value};${endStationInput.value}`;
            
            // ç®—æ³•å‚æ•°
            if (algorithmInput.value === 'theory') {
                shortcode += ';ç†è®º';
            } else if (algorithmInput.value === 'real') {
                shortcode += ';å®æ—¶';
            }
            
            // è¶Šé‡
            if (enableWildCheckbox.checked) {
                shortcode += ';è¶Šé‡';
            }
            
            // ç¦é«˜é“
            if (disableHighSpeedCheckbox.checked) {
                shortcode += ';ç¦é«˜é“';
            }
            
            // ç¦èˆ¹
            if (disableBoatCheckbox.checked) {
                shortcode += ';ç¦èˆ¹';
            }
            
            // ä»…è½»é“
            if (onlyLrtCheckbox.checked) {
                shortcode += ';ä»…è½»é“';
            }
            
            // ç¦è·¯çº¿
            const ignoredLines = ignoredLinesInput.value.split(/[,;ï¼›]/).map(line => line.trim()).filter(Boolean);
            if (ignoredLines.length > 0) {
                shortcode += `;ç¦è·¯çº¿;${ignoredLines.join(';')}`;
            }
            
            // ç¦è½¦ç«™
            const avoidStations = avoidStationsInput.value.split(/[,;ï¼›]/).map(station => station.trim()).filter(Boolean);
            if (avoidStations.length > 0) {
                shortcode += `;ç¦è½¦ç«™;${avoidStations.join(';')}`;
            }
            
            return shortcode;
        }
        
        // å°†generateShortcodeå‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿åœ¨setupStationSearchå‡½æ•°ä¸­è°ƒç”¨
        window.generateShortcode = generateShortcode;
        
        // æ›´æ–°ç®€ç å‡½æ•°
        function updateShortcode() {
            const shortcode = generateShortcode();
            shortcodeInput.value = shortcode;
            // è°ƒæ•´ç®€ç è¾“å…¥æ¡†é«˜åº¦
            if (window.autoResizeTextarea) {
                window.autoResizeTextarea(shortcodeInput);
            }
        }
        
        // å°†updateShortcodeå‡½æ•°æš´éœ²åˆ°å…¨å±€
        window.updateShortcode = updateShortcode;
        
        // ç®€ç è¾“å…¥æ¡†å˜åŒ–æ—¶ï¼Œå¡«å……åˆ°è¡¨å•
        shortcodeInput.addEventListener('input', function() {
            parseShortcode(this.value);
            // è°ƒæ•´è‡ªèº«é«˜åº¦
            if (window.autoResizeTextarea) {
                window.autoResizeTextarea(this);
            }
        });
        
        // è¡¨å•å…ƒç´ å˜åŒ–æ—¶ï¼Œç”Ÿæˆç®€ç 
        const formElements = [
            startStationInput,
            endStationInput,
            ignoredLinesInput,
            avoidStationsInput,
            disableHighSpeedCheckbox,
            disableBoatCheckbox,
            enableWildCheckbox,
            onlyLrtCheckbox,
            algorithmInput
        ];
        
        formElements.forEach(element => {
            if (element.type === 'checkbox') {
                element.addEventListener('change', function() {
                    shortcodeInput.value = generateShortcode();
                    // è°ƒæ•´ç®€ç è¾“å…¥æ¡†é«˜åº¦
                    if (window.autoResizeTextarea) {
                        window.autoResizeTextarea(shortcodeInput);
                    }
                });
            } else {
                element.addEventListener('input', function() {
                    shortcodeInput.value = generateShortcode();
                    // è°ƒæ•´ç®€ç è¾“å…¥æ¡†é«˜åº¦
                    if (window.autoResizeTextarea) {
                        window.autoResizeTextarea(shortcodeInput);
                    }
                    // è°ƒæ•´è‡ªèº«é«˜åº¦
                    if (window.autoResizeTextarea) {
                        window.autoResizeTextarea(this);
                    }
                });
            }
        });
        
        // ç®—æ³•é€‰é¡¹å¡å˜åŒ–æ—¶ï¼Œæ›´æ–°ç®€ç 
        document.querySelectorAll('.algorithm-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                setTimeout(() => {
                    shortcodeInput.value = generateShortcode();
                    // è°ƒæ•´ç®€ç è¾“å…¥æ¡†é«˜åº¦
                    if (window.autoResizeTextarea) {
                        window.autoResizeTextarea(shortcodeInput);
                    }
                }, 0);
            });
        });
    });
    
    // ç®—æ³•é€‰é¡¹å¡å¤„ç†
    const algorithmTabs = document.querySelectorAll('.algorithm-tab');
    const algorithmDisplay = document.getElementById('algorithm-display');
    const algorithmInput = document.getElementById('algorithm');
    
    algorithmTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡çš„activeç±»
            algorithmTabs.forEach(t => t.classList.remove('active'));
            
            // æ·»åŠ å½“å‰é€‰é¡¹å¡çš„activeç±»
            this.classList.add('active');
            
            // æ›´æ–°ç®—æ³•æ˜¾ç¤ºå’Œéšè—è¾“å…¥
            const index = parseInt(this.dataset.index);
            algorithmDisplay.textContent = algorithmMap[index].label;
            algorithmInput.value = algorithmMap[index].value;
        });
    });
    
    // è½¦ç«™æ¨¡ç³Šæœç´¢
    function setupStationSearch(inputId, suggestionsId) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        
        input.addEventListener('input', async function() {
            const query = this.value.trim();
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch(`/api/search_stations?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                suggestions.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(station => {
                        const div = document.createElement('div');
                        div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        div.textContent = station;
                        div.addEventListener('click', () => {
                            input.value = station;
                            suggestions.classList.add('hidden');
                            // æ›´æ–°ç®€ç 
                            if (window.generateShortcode) {
                                const shortcodeInput = document.getElementById('shortcode');
                                if (shortcodeInput) {
                                    shortcodeInput.value = window.generateShortcode();
                                }
                            }
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                suggestions.classList.add('hidden');
            }
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®åˆ—è¡¨
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
        });
    }
    
    setupStationSearch('start-station', 'start-suggestions');
    setupStationSearch('end-station', 'end-suggestions');
    
    // è¡¨å•æäº¤å¤„ç†
    const routeForm = document.getElementById('route-form');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const result = document.getElementById('result');
    const noResult = document.getElementById('no-result');
    
    // è¿›åº¦æ¡ç›¸å…³å…ƒç´ 
    const progressBar = document.getElementById('progress-bar');
    const progressStage = document.getElementById('progress-stage');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressMessage = document.getElementById('progress-message');
    
    // è½®è¯¢ç›¸å…³å˜é‡
    let progressInterval = null;
    let requestId = null;
    
    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress(progress) {
        progressBar.style.width = `${progress.percentage}%`;
        progressStage.textContent = progress.stage;
        progressPercentage.textContent = `${progress.percentage}%`;
        if (progress.message) {
            progressMessage.textContent = progress.message;
        }
    }
    
    // å¼€å§‹è½®è¯¢è¿›åº¦
    function startProgressPolling() {
        // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
        if (progressInterval) {
            clearInterval(progressInterval);
        }
        
        // åˆå§‹åŒ–è¿›åº¦
        updateProgress({
            percentage: 0,
            stage: 'å‡†å¤‡ä¸­...',
            message: 'æ­£åœ¨åˆå§‹åŒ–å¯»è·¯å‚æ•°...'
        });
        
        // å¼€å§‹è½®è¯¢
        progressInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/progress');
                const progress = await response.json();
                updateProgress(progress);
                
                // å¦‚æœè¿›åº¦è¾¾åˆ°100%ï¼Œåœæ­¢è½®è¯¢
                if (progress.percentage >= 100) {
                    clearInterval(progressInterval);
                }
            } catch (err) {
                console.error('è·å–è¿›åº¦å¤±è´¥:', err);
            }
        }, 500); // æ¯500æ¯«ç§’æŸ¥è¯¢ä¸€æ¬¡è¿›åº¦
    }
    
    routeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        loading.classList.remove('hidden');
        error.classList.add('hidden');
        result.classList.add('hidden');
        noResult.classList.add('hidden');
        
        // å¼€å§‹è½®è¯¢è¿›åº¦
        startProgressPolling();
        
        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = new FormData(routeForm);
        const data = {
            start: formData.get('start'),
            end: formData.get('end'),
            ignored_lines: formData.get('ignored_lines').split(',').map(s => s.trim()).filter(Boolean),
            avoid_stations: formData.get('avoid_stations').split(',').map(s => s.trim()).filter(Boolean),
            disable_high_speed: formData.get('disable_high_speed') === 'on',
            disable_boat: formData.get('disable_boat') === 'on',
            enable_wild: formData.get('enable_wild') === 'on',
            only_lrt: formData.get('only_lrt') === 'on',
            algorithm: formData.get('algorithm')
        };
        
        try {
            // è½¬æ¢ç¦è·¯çº¿å’Œç¦è½¦ç«™çš„åˆ†éš”ç¬¦ä¸ºé€—å·ï¼Œä»¥é€‚åº”APIè¦æ±‚
            data.ignored_lines = formData.get('ignored_lines').split(/[,;ï¼›]/).map(s => s.trim()).filter(Boolean);
            data.avoid_stations = formData.get('avoid_stations').split(/[,;ï¼›]/).map(s => s.trim()).filter(Boolean);
            
            // å‘é€è¯·æ±‚
            const response = await fetch('/api/find_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const resultData = await response.json();
            
            // åœæ­¢è½®è¯¢
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            if (response.ok) {
                if (resultData.result) {
                    // æ˜¾ç¤ºç»“æœï¼Œä¼ é€’å¯»è·¯æ¨¡å¼ã€è®¡ç®—ç”¨æ—¶ã€æ•°æ®ç‰ˆæœ¬å’Œç¼“å­˜æ ‡å¿—
                    displayResult(resultData.result, resultData.algorithm, resultData.calc_time, resultData.data_versions, resultData.used_cache);
                } else {
                    // æ— ç»“æœ
                    noResult.classList.remove('hidden');
                }
            } else {
                // æ˜¾ç¤ºé”™è¯¯
                error.textContent = resultData.error || 'å¯»è·¯å¤±è´¥';
                error.classList.remove('hidden');
            }
        } catch (err) {
            // åœæ­¢è½®è¯¢
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            
            // æ˜¾ç¤ºé”™è¯¯
            error.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            error.classList.remove('hidden');
            console.error('å¯»è·¯é”™è¯¯:', err);
        } finally {
            // éšè—åŠ è½½çŠ¶æ€
            loading.classList.add('hidden');
        }
    });
    
    // æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºHH:MM:SSæ ¼å¼
    function formatTimestamp(timestamp) {
        if (typeof timestamp !== 'number') return '';
        
        const date = new Date(timestamp * 1000);
        return date.toISOString().substring(11, 19);
    }
    
    // æ˜¾ç¤ºç»“æœ
    function displayResult(routeResult, algorithm, calcTime, dataVersions, usedCache) {
        result.classList.remove('hidden');
        
        // è§£ærouteresultæ•°ç»„ï¼Œæ·»åŠ é»˜è®¤å€¼å¤„ç†
        const totalTime = routeResult[0] || 0; // æ€»ç”¨æ—¶ (å…ƒç´ 0, ç§’)
        const travelingTime = routeResult[3] || 0; // ä¹˜è½¦æ—¶é—´ (å…ƒç´ 3, ç§’)
        const waitingTime = routeResult[4] || 0; // ç­‰è½¦æ—¶é—´ (å…ƒç´ 4, ç§’)
        
        // ç¡®ä¿stationNamesæ˜¯æ•°ç»„
        const stationNames = Array.isArray(routeResult[1]) ? routeResult[1] : [];
        
        // ç¡®ä¿routeDetailsæ˜¯æ•°ç»„ï¼Œé¿å…TypeError
        const routeDetails = Array.isArray(routeResult[2]) ? routeResult[2] : [];
        
        // æ¸…ç©ºç°æœ‰å†…å®¹
        const detailsContainer = document.getElementById('route-details');
        detailsContainer.innerHTML = '';
        
        // 1. åˆ›å»ºæ—¶é—´ä¿¡æ¯éƒ¨åˆ†
        const timeInfoDiv = document.createElement('div');
        timeInfoDiv.className = 'time-info';
        timeInfoDiv.id = 'time-info';
        
        // æ„å»ºæ—¶é—´ç½‘æ ¼å†…å®¹ï¼Œç†è®ºæ¨¡å¼ä¸‹åªæ˜¾ç¤ºæ€»ç”¨æ—¶
        let timeGridContent = `
            <div class="time-grid ${algorithm === 'theory' ? 'theory-mode' : ''}">
                <div class="time-item total-time">
                    <div class="time-icon">â±ï¸</div>
                    <div class="time-content">
                        <strong id="total-time">${formatTime(totalTime)}</strong>
                        <span>æ€»ç”¨æ—¶</span>
                    </div>
                </div>
        `;
        
        // éç†è®ºæ¨¡å¼ä¸‹æ˜¾ç¤ºä¹˜è½¦æ—¶é—´å’Œç­‰è½¦æ—¶é—´
        if (algorithm !== 'theory') {
            timeGridContent += `
                <div class="time-item traveling-time">
                    <div class="time-icon">ğŸš‚</div>
                    <div class="time-content">
                        <strong id="traveling-time">${formatTime(travelingTime)}</strong>
                        <span>ä¹˜è½¦æ—¶é—´</span>
                    </div>
                </div>
                <div class="time-item waiting-time">
                    <div class="time-icon">â³</div>
                    <div class="time-content">
                        <strong id="waiting-time">${formatTime(waitingTime)}</strong>
                        <span>ç­‰è½¦æ—¶é—´</span>
                    </div>
                </div>
            `;
        }
        
        // æ·»åŠ å¯»è·¯è®¡ç®—ç”¨æ—¶
        const cacheBadge = usedCache ? '<span style="color: green; font-size: 0.75rem; display: block; margin-bottom: -2px;">(è°ƒç”¨ç¼“å­˜)</span>' : '';
        timeGridContent += `
                <div class="time-item calc-time">
                    <div class="time-icon">âš¡</div>
                    <div class="time-content">
                        <strong>${calcTime ? calcTime.toFixed(2) + 's' : '-'}</strong>
                        ${cacheBadge}
                        <span>è®¡ç®—ç”¨æ—¶</span>
                    </div>
                </div>
        `;
        
        // æ·»åŠ æ•°æ®ç‰ˆæœ¬ä¿¡æ¯
        if (dataVersions) {
            // æ ¹æ®ç®—æ³•é€‰æ‹©ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„æ•°æ®
            if (algorithm === 'real') {
                // å®æ—¶å¯»è·¯ä½¿ç”¨v4ç‰ˆæœ¬æ•°æ®
                if (dataVersions.station_version_v4) {
                    timeGridContent += `
                        <div class="time-item data-version">
                            <div class="time-icon">ğŸ“…</div>
                            <div class="time-content">
                                <strong>${dataVersions.station_version_v4}</strong>
                                <span>è½¦ç«™æ•°æ®ç‰ˆæœ¬(V4)</span>
                            </div>
                        </div>
                    `;
                }
                if (dataVersions.route_version_v4) {
                    timeGridContent += `
                        <div class="time-item data-version">
                            <div class="time-icon">ğŸ—ºï¸</div>
                            <div class="time-content">
                                <strong>${dataVersions.route_version_v4}</strong>
                                <span>çº¿è·¯æ•°æ®ç‰ˆæœ¬(V4)</span>
                            </div>
                        </div>
                    `;
                }
            } else {
                // é»˜è®¤/ç†è®ºå¯»è·¯ä½¿ç”¨v3ç‰ˆæœ¬æ•°æ®
                if (dataVersions.station_version) {
                    timeGridContent += `
                        <div class="time-item data-version">
                            <div class="time-icon">ğŸ“…</div>
                            <div class="time-content">
                                <strong>${dataVersions.station_version}</strong>
                                <span>è½¦ç«™æ•°æ®ç‰ˆæœ¬(V3)</span>
                            </div>
                        </div>
                    `;
                }
                if (dataVersions.interval_version) {
                    timeGridContent += `
                        <div class="time-item data-version">
                            <div class="time-icon">ğŸ—ºï¸</div>
                            <div class="time-content">
                                <strong>${dataVersions.interval_version}</strong>
                                <span>é—´éš”æ•°æ®ç‰ˆæœ¬(V3)</span>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        timeGridContent += `
            </div>
        `;
        
        timeInfoDiv.innerHTML = timeGridContent;
        detailsContainer.appendChild(timeInfoDiv);
        
        // 2. å¤„ç†è·¯çº¿æ­¥éª¤ï¼Œç¡®ä¿stationNamesæœ‰è¶³å¤Ÿå…ƒç´ 
        if (stationNames.length < 2) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = 'è·¯çº¿æ•°æ®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–ç¨åé‡è¯•ã€‚';
            detailsContainer.appendChild(errorDiv);
            return;
        }
        
        // è®¡ç®—éæ­¥è¡Œè·¯çº¿æ•°é‡
        let nonWalkRoutesCount = 0;
        for (const detail of routeDetails) {
            if (Array.isArray(detail)) {
                const trainType = detail[7] || 'train_normal';
                const routeName = detail[3] || '';
                const isWalk = trainType === 'walk' || routeName.toLowerCase().includes('walk') || routeName.includes('æ­¥è¡Œ');
                if (!isWalk) {
                    nonWalkRoutesCount++;
                }
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ‡å‡†åŒ–è½¦ç«™åç§°ï¼Œç”¨äºåŒ¹é…æ¯”è¾ƒ
        function normalizeStationName(name) {
            if (typeof name === 'string') {
                // æ›¿æ¢æ‰€æœ‰åˆ†éš”ç¬¦ä¸ºç©ºæ ¼ï¼Œç„¶åå»é™¤å¤šä½™ç©ºæ ¼
                return name.replace(/[|]/g, ' ').trim().toLowerCase();
            }
            return name;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†ç»ˆç‚¹ç«™åç§°ï¼Œå°† | æ›¿æ¢ä¸ºç©ºæ ¼
        function formatTerminusName(name) {
            if (typeof name === 'string') {
                return name.replace('|', ' ').trim();
            }
            return name;
        }
        
        // å‡½æ•°ï¼šé‡æ–°è®¡ç®—å¹¶æ›´æ–°æ€»ç”¨æ—¶
        function updateTotalTime() {
            let totalTravelingTime = 0;
            let totalWaitingTime = 0;
            
            // è·å–æ‰€æœ‰è·¯çº¿ä¿¡æ¯å…ƒç´ 
            const routeInfoElements = document.querySelectorAll('.route-info');
            
            // éå†æ¯ä¸ªè·¯çº¿ä¿¡æ¯
            routeInfoElements.forEach(routeInfo => {
                // æå–ä¹˜è½¦æ—¶é—´æˆ–æ­¥è¡Œæ—¶é—´
                const timeDetails = routeInfo.querySelectorAll('.time-detail');
                timeDetails.forEach(detail => {
                    const timeValue = detail.querySelector('.time-value');
                    if (timeValue) {
                        const timeText = timeValue.textContent;
                        const seconds = parseTimeString(timeText);
                        
                        // åˆ¤æ–­æ˜¯ä¹˜è½¦æ—¶é—´è¿˜æ˜¯ç­‰è½¦æ—¶é—´
                        if (detail.textContent.includes('ä¹˜è½¦æ—¶é—´') || detail.textContent.includes('æ­¥è¡Œæ—¶é—´')) {
                            totalTravelingTime += seconds;
                        } else if (detail.textContent.includes('ç­‰è½¦æ—¶é—´')) {
                            totalWaitingTime += seconds;
                        }
                    }
                });
            });
            
            // è®¡ç®—æ€»ç”¨æ—¶
            const totalTime = totalTravelingTime + totalWaitingTime;
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            document.getElementById('total-time').textContent = formatTime(totalTime);
            document.getElementById('traveling-time').textContent = formatTime(totalTravelingTime);
            document.getElementById('waiting-time').textContent = formatTime(totalWaitingTime);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºç§’æ•°
        function parseTimeString(timeStr) {
            const parts = timeStr.split(':');
            let seconds = 0;
            
            if (parts.length === 3) {
                // h:mm:ss
                seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
            } else if (parts.length === 2) {
                // mm:ss
                seconds = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            
            return seconds;
        }
        
        // å‡½æ•°ï¼šæ„å»ºè·¯çº¿ä¿¡æ¯
        function buildRouteInfo(routeDetail, matchedRouteDetails, totalWaitingTime, nonWalkRoutesCount, algorithm, lineRidingTime = null, lineWaitingTime = null) {
            const routeInfoDiv = document.createElement('div');
            routeInfoDiv.className = 'route-info';
            
            // è§£æè·¯çº¿è¯¦ç»†ä¿¡æ¯ï¼Œæ·»åŠ é»˜è®¤å€¼
            // è·¯çº¿è¯¦æƒ…æ•°ç»„ç»“æ„ï¼š[èµ·ç‚¹, ç»ˆç‚¹, é¢œè‰², è·¯çº¿å, ç»ˆç‚¹ç«™ä¿¡æ¯, æ—¶é•¿, ç­‰è½¦æ—¶é—´, å‘è½¦é—´éš”, äº¤é€šç±»å‹]
            const [, , color = '#4a90e2', routeName = '', terminus = '', duration = 0, segmentWaitingTime = 0, departureInterval = 0, trainType = 'train_normal'] = routeDetail;
            
            // å¤„ç†è·¯çº¿åç§°ï¼Œåªä¿ç•™ä¸­æ–‡å’Œè‹±æ–‡ï¼Œå»é™¤æ–¹å‘å’Œåˆ†éš”ç¬¦
            // åŸå§‹æ ¼å¼ï¼š"åœ°éµå—å¤§é™¸ç¶«åŒ—æ®µ|Metro South Continental Line N. Section||to New Red Leaves"
            // ç›®æ ‡æ ¼å¼ï¼š"åœ°éµå—å¤§é™¸ç¶«åŒ—æ®µ Metro South Continental Line N. Section"
            let processedRouteName = routeName;
            if (processedRouteName.includes('||')) {
                processedRouteName = processedRouteName.split('||')[0];
            }
            processedRouteName = processedRouteName.replace('|', ' ').trim();
            
            // åˆ›å»ºè·¯çº¿æ ‡ç­¾ï¼Œä½¿ç”¨æ­£ç¡®çš„é¢œè‰²
            const routeTag = document.createElement('div');
            routeTag.className = 'route-tag';
            routeTag.style.backgroundColor = color;
            
            // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
            const textColor = getContrastTextColor(color);
            routeTag.style.color = textColor;
            
            // è·å–äº¤é€šå›¾æ ‡
            const transportIcon = getTransportIcon(trainType);
            const transportName = getTransportName(trainType);
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ­¥è¡Œè·¯çº¿
            const isWalk = trainType === 'walk' || processedRouteName.toLowerCase().includes('walk') || processedRouteName.includes('æ­¥è¡Œ');
            
            // æ¸…ç©ºå¹¶é‡æ–°è®¾ç½®routeTagæ ·å¼
            routeTag.innerHTML = '';
            routeTag.style.display = 'flex';
            routeTag.style.alignItems = 'center';
            routeTag.style.justifyContent = 'space-between';
            
            // è·¯çº¿ä¿¡æ¯å·¦ä¾§å†…å®¹
            const routeLeftContent = document.createElement('div');
            routeLeftContent.style.display = 'flex';
            routeLeftContent.style.alignItems = 'center';
            
            // æ­¥è¡Œè·¯çº¿ä¸æ˜¾ç¤ºæ‹¬å·å†…çš„äº¤é€šç±»å‹
            if (isWalk) {
                routeLeftContent.innerHTML = `
                    ${transportIcon}
                    <span class="route-name">${processedRouteName}</span>
                `;
            } else {
                routeLeftContent.innerHTML = `
                    ${transportIcon}
                    <span class="route-name">${processedRouteName}</span>
                    <span style="margin-left: 8px; opacity: 0.8;">(${transportName})</span>
                `;
            }
            
            // æ·»åŠ å‰æŒ‰é’®
            const routeCloseBtn = document.createElement('button');
            routeCloseBtn.className = 'route-close-btn';
            routeCloseBtn.innerHTML = '&times;';
            routeCloseBtn.style.cssText = `
                background: none;
                border: none;
                width: auto;
                height: auto;
                cursor: pointer;
                font-size: 1rem;
                line-height: 1;
                padding: 0.8px;
                opacity: 0.7;
                transition: color 0.2s;
                margin-left: 8px;
            `;
            
            // ç¡®ä¿æŒ‰é’®æ–‡å­—é¢œè‰²ä¸çº¿è·¯æ ‡ç­¾ä¸€è‡´
            routeCloseBtn.style.color = textColor;
            
            // æ‚¬åœæ•ˆæœ
            routeCloseBtn.addEventListener('mouseenter', function() {
                this.style.opacity = 1;
                this.style.color = '#ef4444';
            });
            routeCloseBtn.addEventListener('mouseleave', function() {
                this.style.opacity = 0.7;
                this.style.color = textColor;
            });
            
            // ç‚¹å‡»äº‹ä»¶ï¼šæ·»åŠ åˆ°ç¦è·¯çº¿
            routeCloseBtn.addEventListener('click', function() {
                const ignoredLinesInput = document.getElementById('ignored-lines');
                const currentValue = ignoredLinesInput.value;
                const routeValue = processedRouteName;
                
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const lines = currentValue.split(/[,;ï¼›]/).map(line => line.trim()).filter(Boolean);
                if (!lines.includes(routeValue)) {
                    lines.push(routeValue);
                    ignoredLinesInput.value = lines.join(';');
                    // è§¦å‘è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                    if (window.autoResizeTextarea) {
                        window.autoResizeTextarea(ignoredLinesInput);
                    }
                    // æ›´æ–°ç®€ç 
                    if (typeof updateShortcode === 'function') {
                        updateShortcode();
                    }
                }
            });
            
            // ç›´æ¥æ·»åŠ å†…å®¹åˆ°routeTag
            routeTag.appendChild(routeLeftContent);
            routeTag.appendChild(routeCloseBtn);
            routeInfoDiv.appendChild(routeTag);
            
            // åªæœ‰éæ­¥è¡Œè·¯çº¿æ‰æ˜¾ç¤ºæ–¹å‘æŒ‡ç¤ºå™¨
            if (!isWalk) {
                // æ˜¾ç¤ºæ–¹å‘æŒ‡ç¤ºå™¨ï¼ˆç»ˆç‚¹ç«™ï¼‰
                // terminus çš„æ ¼å¼å¯èƒ½æ˜¯ï¼š
                //   - æ™®é€šè·¯çº¿ï¼š("ç»ˆç‚¹ç«™ä¸­æ–‡", "ç»ˆç‚¹ç«™è‹±æ–‡") å…ƒç»„
                //   - ç¯çº¿ï¼š(true, "ç¯çº¿ä¸­æ–‡", "ç¯çº¿è‹±æ–‡") å…ƒç»„
                //   - å­—ç¬¦ä¸²æ ¼å¼
                const directionIndicator = document.createElement('div');
                directionIndicator.className = 'direction-indicator';
                
                let terminusDisplay = '';
                
                // åœ¨JavaScriptä¸­ï¼ŒPythonå…ƒç»„ä¼šè¢«è½¬æ¢ä¸ºæ•°ç»„ï¼Œæ‰€ä»¥ç›´æ¥æ£€æŸ¥æ˜¯å¦ä¸ºæ•°ç»„
                if (Array.isArray(terminus)) {
                    if (terminus.length >= 2) {
                        if (terminus[0] === true && terminus.length >= 3) {
                            // ç¯çº¿æ ¼å¼ï¼š[true, "ç¯çº¿ä¸­æ–‡", "ç¯çº¿è‹±æ–‡"]
                            const terminus1 = formatTerminusName(terminus[1]);
                            const terminus2 = formatTerminusName(terminus[2]);
                            // ç›´æ¥æ˜¾ç¤ºç¯çº¿ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        } else {
                            // æ™®é€šè·¯çº¿ï¼š["ç»ˆç‚¹ç«™ä¸­æ–‡", "ç»ˆç‚¹ç«™è‹±æ–‡"]
                            const terminus1 = formatTerminusName(terminus[0]);
                            const terminus2 = formatTerminusName(terminus[1]);
                            // ç›´æ¥æ˜¾ç¤ºç»ˆç‚¹ç«™ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        }
                    }
                } else if (typeof terminus === 'object' && terminus !== null) {
                    // å¤„ç†å¯¹è±¡æ ¼å¼ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    const keys = Object.keys(terminus);
                    if (keys.length >= 2) {
                        if (terminus[0] === true && keys.length >= 3) {
                            // ç¯çº¿æ ¼å¼ï¼š{0: true, 1: "ç¯çº¿ä¸­æ–‡", 2: "ç¯çº¿è‹±æ–‡"}
                            const terminus1 = formatTerminusName(terminus[1]);
                            const terminus2 = formatTerminusName(terminus[2]);
                            // ç›´æ¥æ˜¾ç¤ºç¯çº¿ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        } else {
                            // æ™®é€šè·¯çº¿ï¼š{0: "ç»ˆç‚¹ç«™ä¸­æ–‡", 1: "ç»ˆç‚¹ç«™è‹±æ–‡"}
                            const terminus1 = formatTerminusName(terminus[0]);
                            const terminus2 = formatTerminusName(terminus[1]);
                            // ç›´æ¥æ˜¾ç¤ºç»ˆç‚¹ç«™ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        }
                    }
                } else if (typeof terminus === 'string') {
                    // å­—ç¬¦ä¸²æ ¼å¼ï¼Œå¯èƒ½åŒ…å« | åˆ†éš”ç¬¦
                    const formattedTerminus = formatTerminusName(terminus);
                    // ç›´æ¥æ˜¾ç¤ºç»ˆç‚¹ç«™ä¿¡æ¯
                    terminusDisplay = formattedTerminus;
                }
                
                directionIndicator.textContent = terminusDisplay;
                routeInfoDiv.appendChild(directionIndicator);
            }
            
            // æ˜¾ç¤ºä¹˜è½¦æ—¶é•¿æˆ–æ­¥è¡Œæ—¶é—´
            const durationDiv = document.createElement('div');
            durationDiv.className = 'time-detail';
            const timeLabel = isWalk ? 'ğŸ• æ­¥è¡Œæ—¶é—´' : 'ğŸ• ä¹˜è½¦æ—¶é—´';
            // å®æ—¶æ¨¡å¼ä½¿ç”¨è®¡ç®—çš„ä¹˜è½¦æ—¶é—´ï¼Œå¦åˆ™ä½¿ç”¨åŸå§‹duration
            const displayRidingTime = algorithm === 'real' && lineRidingTime !== null ? lineRidingTime : duration;
            durationDiv.innerHTML = `<span>${timeLabel}</span><span class="time-value">${formatTime(displayRidingTime)}</span>`;
            routeInfoDiv.appendChild(durationDiv);
            
            // åªæœ‰éæ­¥è¡Œè·¯çº¿ä¸”ä¸æ˜¯ç†è®ºæ¨¡å¼æ‰æ˜¾ç¤ºç­‰è½¦æ—¶é—´å’Œå‘è½¦é—´éš”
            // å®æ—¶æ¨¡å¼ä¸‹çš„ç­‰è½¦æ—¶é—´å·²ç»æ˜¾ç¤ºåœ¨å‡ºç«™æ—¶é—´ä¸Šæ–¹
            if (!isWalk && algorithm !== 'theory') {
                // éå®æ—¶æ¨¡å¼ä¸‹æ˜¾ç¤ºç­‰è½¦æ—¶é—´
                if (algorithm !== 'real') {
                    const waitingDiv = document.createElement('div');
                    waitingDiv.className = 'time-detail';
                    // éå®æ—¶æ¨¡å¼ä½¿ç”¨è·¯çº¿è¯¦æƒ…ä¸­çš„ç­‰è½¦æ—¶é—´
                    waitingDiv.innerHTML = `<span>â³ ç­‰è½¦æ—¶é—´</span><span class="time-value">${formatTime(segmentWaitingTime)}</span>`;
                    routeInfoDiv.appendChild(waitingDiv);
                    
                    // éå®æ—¶æ¨¡å¼ä¸‹æ˜¾ç¤ºå‘è½¦é—´éš”ï¼ˆä½¿ç”¨è·¯çº¿è¯¦æƒ…ä¸­çš„å‘è½¦é—´éš”ï¼Œindex 7ï¼‰
                    const intervalDiv = document.createElement('div');
                    intervalDiv.className = 'time-detail';
                    intervalDiv.innerHTML = `<span>â³ å‘è½¦é—´éš”</span><span class="time-value">${formatTime(departureInterval)}</span>`;
                    routeInfoDiv.appendChild(intervalDiv);
                }
            }
            
            // å¦‚æœæœ‰å…¶ä»–åŒ¹é…çš„è·¯çº¿ï¼Œæ˜¾ç¤º"æˆ–"é€‰é¡¹
            if (matchedRouteDetails.length > 1) {
                const otherRoutesDiv = document.createElement('div');
                otherRoutesDiv.className = 'other-routes';
                otherRoutesDiv.innerHTML = '<div class="other-routes-label">æˆ–</div>';
                
                const otherRoutesList = document.createElement('div');
                otherRoutesList.className = 'other-routes-list';
                
                // éå†å…¶ä»–åŒ¹é…çš„è·¯çº¿
                for (let j = 0; j < matchedRouteDetails.length; j++) {
                    // è·³è¿‡å½“å‰æ˜¾ç¤ºçš„è·¯çº¿
                    if (matchedRouteDetails[j] === routeDetail) {
                        continue;
                    }
                    
                    const otherRoute = matchedRouteDetails[j];
                    // æ­£ç¡®çš„æ•°ç»„è§£æ„ï¼š[èµ·ç‚¹, ç»ˆç‚¹, é¢œè‰², è·¯çº¿å, ç»ˆç‚¹ç«™ä¿¡æ¯, æ—¶é•¿, ç­‰è½¦æ—¶é—´, å‘è½¦é—´éš”, äº¤é€šç±»å‹]
                    const [, , otherColor = '#4a90e2', otherRouteName = '', , otherDuration = 0, , , otherTrainType = 'train_normal'] = otherRoute;
                    
                    // å¤„ç†å…¶ä»–è·¯çº¿åç§°
                    let processedOtherRouteName = otherRouteName;
                    if (processedOtherRouteName.includes('||')) {
                        processedOtherRouteName = processedOtherRouteName.split('||')[0];
                    }
                    processedOtherRouteName = processedOtherRouteName.replace('|', ' ').trim();
                    
                    // åˆ›å»ºå…¶ä»–è·¯çº¿æ ‡ç­¾
                    const otherRouteTag = document.createElement('div');
                    otherRouteTag.className = 'other-route-tag';
                    otherRouteTag.style.backgroundColor = otherColor;
                    
                    // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
                    const otherTextColor = getContrastTextColor(otherColor);
                    otherRouteTag.style.color = otherTextColor;
                    
                    // è·å–äº¤é€šå›¾æ ‡
                    const otherTransportIcon = getTransportIcon(otherTrainType);
                    const otherTransportName = getTransportName(otherTrainType);
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ­¥è¡Œè·¯çº¿
                    const otherIsWalk = otherTrainType === 'walk' || processedOtherRouteName.toLowerCase().includes('walk') || processedOtherRouteName.includes('æ­¥è¡Œ');
                    
                    // æ­¥è¡Œè·¯çº¿ä¸æ˜¾ç¤ºæ‹¬å·å†…çš„äº¤é€šç±»å‹
                    if (otherIsWalk) {
                        otherRouteTag.innerHTML = `
                            ${otherTransportIcon}
                            <span class="other-route-name">${processedOtherRouteName}</span>
                        `;
                    } else {
                        otherRouteTag.innerHTML = `
                            ${otherTransportIcon}
                            <span class="other-route-name">${processedOtherRouteName}</span>
                            <span style="margin-left: 4px; opacity: 0.8; font-size: 0.85em;">(${otherTransportName})</span>
                        `;
                    }
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    otherRouteTag.addEventListener('click', function() {
                        // é‡æ–°æ„å»ºè·¯çº¿ä¿¡æ¯
                        const newRouteInfo = buildRouteInfo(otherRoute, matchedRouteDetails, totalWaitingTime, nonWalkRoutesCount, algorithm);
                        // æ›¿æ¢å½“å‰è·¯çº¿ä¿¡æ¯
                        routeInfoDiv.parentNode.replaceChild(newRouteInfo, routeInfoDiv);
                        // æ›´æ–°æ€»ç”¨æ—¶
                        updateTotalTime();
                    });
                    
                    otherRoutesList.appendChild(otherRouteTag);
                }
                
                otherRoutesDiv.appendChild(otherRoutesList);
                routeInfoDiv.appendChild(otherRoutesDiv);
            }
            
            return routeInfoDiv;
        }
        
        // 3. æ·»åŠ å‡ºå‘æ—¶é—´æˆ³ï¼ˆä»…å®æ—¶æ¨¡å¼ï¼‰
        if (algorithm === 'real') {
            const departureTimeDiv = document.createElement('div');
            departureTimeDiv.className = 'time-stamp departure-time';
            // ä½¿ç”¨ç¬¬ä¸€æ¡è·¯çº¿çš„å‘è½¦æ—¶é—´ä½œä¸ºæ€»å‡ºå‘æ—¶é—´
            const departureTime = routeDetails.length > 0 ? routeDetails[0][5] : 0;
            departureTimeDiv.textContent = `å‡ºå‘æ—¶é—´: ${formatTimestamp(departureTime)}`;
            detailsContainer.appendChild(departureTimeDiv);
        }
        
        for (let i = 0; i < stationNames.length - 1; i += 2) {
            const currentStation = stationNames[i] || '';
            const routeInfo = stationNames[i + 1] || '';
            const nextStation = stationNames[i + 2] || stationNames[stationNames.length - 1] || '';
            
            // æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è¯¦ç»†è·¯çº¿ä¿¡æ¯
            let matchedRouteDetails = [];
            
            for (const detail of routeDetails) {
                if (Array.isArray(detail)) {
                    const detailStart = detail[0] || '';
                    const detailEnd = detail[1] || '';
                    
                    // ä½¿ç”¨æ ‡å‡†åŒ–åç§°è¿›è¡ŒåŒ¹é…
                    if (normalizeStationName(detailStart) === normalizeStationName(currentStation) && 
                        normalizeStationName(detailEnd) === normalizeStationName(nextStation)) {
                        matchedRouteDetails.push(detail);
                    }
                }
            }
            
            // 1. æ˜¾ç¤ºå½“å‰è½¦ç«™åç§° - å•ç‹¬æˆä¸€æ ¼
            const stationStep = document.createElement('div');
            stationStep.className = `route-step ${i === 0 ? 'start-station' : ''}`;
            
            const stationDiv = document.createElement('div');
            stationDiv.className = 'station';
            stationDiv.style.display = 'flex';
            stationDiv.style.alignItems = 'center';
            stationDiv.style.justifyContent = 'space-between';
            stationDiv.style.textAlign = 'left';
            
            // æ›¿æ¢è½¦ç«™åç§°ä¸­çš„æ‰€æœ‰ç«–æ ä¸ºç©ºæ ¼
            const formattedStationName = currentStation.replace(/\|/g, ' ');
            
            // è½¦ç«™åç§°æ–‡æœ¬
            const stationNameSpan = document.createElement('span');
            stationNameSpan.textContent = formattedStationName;
            stationNameSpan.style.flex = '1';
            stationNameSpan.style.textAlign = 'left';
            stationDiv.appendChild(stationNameSpan);
            
            // åªç»™éèµ·ç‚¹ç«™æ·»åŠ å‰æŒ‰é’®
            if (i !== 0) {
                const stationCloseBtn = document.createElement('button');
                stationCloseBtn.className = 'station-close-btn';
                stationCloseBtn.innerHTML = '&times;';
                stationCloseBtn.style.cssText = `
                    background: none;
                    border: none;
                    width: auto;
                    height: auto;
                    cursor: pointer;
                    font-size: 1rem;
                    line-height: 1;
                    opacity: 0.7;
                    transition: color 0.2s;
                    color: #6b7280;
                    margin-left: 8px;
                `;
                
                // æ‚¬åœæ•ˆæœ
                stationCloseBtn.addEventListener('mouseenter', function() {
                    this.style.opacity = 1;
                    this.style.color = '#ef4444';
                });
                stationCloseBtn.addEventListener('mouseleave', function() {
                    this.style.opacity = 0.7;
                    this.style.color = '#6b7280';
                });
                
                // ç‚¹å‡»äº‹ä»¶ï¼šæ·»åŠ åˆ°ç¦è½¦ç«™
                stationCloseBtn.addEventListener('click', function() {
                    const avoidStationsInput = document.getElementById('avoid-stations');
                    const currentValue = avoidStationsInput.value;
                    const stationValue = formattedStationName;
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const stations = currentValue.split(/[,;ï¼›]/).map(s => s.trim()).filter(Boolean);
                    if (!stations.includes(stationValue)) {
                        stations.push(stationValue);
                        avoidStationsInput.value = stations.join(';');
                        // è§¦å‘è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                        if (window.autoResizeTextarea) {
                            window.autoResizeTextarea(avoidStationsInput);
                        }
                        // æ›´æ–°ç®€ç 
                        if (typeof updateShortcode === 'function') {
                            updateShortcode();
                        }
                    }
                });
                
                stationDiv.appendChild(stationCloseBtn);
            }
            stationStep.appendChild(stationDiv);
            detailsContainer.appendChild(stationStep);
            
            // 2. åˆ›å»ºè·¯çº¿æ­¥éª¤å®¹å™¨ - åªåŒ…å«è·¯çº¿ä¿¡æ¯
            const routeStep = document.createElement('div');
            routeStep.className = 'route-step';
            
            if (matchedRouteDetails.length > 0) {
                // æ˜¾ç¤ºç¬¬ä¸€ç§è·¯çº¿çš„è¯¦ç»†ä¿¡æ¯
                const currentRouteDetail = matchedRouteDetails[0];
                
                // ä»…å®æ—¶æ¨¡å¼æ˜¾ç¤ºæ—¶é—´ä¿¡æ¯
                if (algorithm === 'real') {
                    const departureTime = currentRouteDetail[5] || 0;
                    const arrivalTime = currentRouteDetail[6] || 0;
                    
                    // è®¡ç®—æœ¬çº¿è·¯çš„ä¹˜è½¦æ—¶é—´
                    const lineRidingTime = arrivalTime - departureTime;
                    
                    // è®¡ç®—ç­‰è½¦æ—¶é—´ï¼ˆæœ¬çº¿è·¯å‡ºç«™æ—¶é—´ - ä¸Šä¸€çº¿è·¯åˆ°ç«™æ—¶é—´ï¼‰
                    let lineWaitingTime = 0;
                    if (i > 0 && i < stationNames.length - 1) {
                        // æ‰¾åˆ°ä¸Šä¸€æ¡è·¯çº¿çš„åˆ°ç«™æ—¶é—´
                        const prevRouteIndex = Math.floor((i - 2) / 2);
                        if (prevRouteIndex >= 0 && routeDetails[prevRouteIndex]) {
                            const prevArrivalTime = routeDetails[prevRouteIndex][6] || 0;
                            lineWaitingTime = departureTime - prevArrivalTime;
                        }
                    }
                    
                    // æ˜¾ç¤ºç­‰è½¦æ—¶é—´ï¼ˆå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¡è·¯çº¿ï¼‰
                    if (i > 0 && i < stationNames.length - 1 && lineWaitingTime > 0) {
                        const waitingTimeDiv = document.createElement('div');
                        waitingTimeDiv.className = 'time-detail';
                        waitingTimeDiv.innerHTML = `<span>â³ ç­‰è½¦æ—¶é—´</span><span class="time-value">${formatTime(lineWaitingTime)}</span>`;
                        routeStep.appendChild(waitingTimeDiv);
                    }
                    
                    // æ˜¾ç¤ºçº¿è·¯å‰çš„å‘è½¦æ—¶é—´
                    const departureTimeDiv = document.createElement('div');
                    departureTimeDiv.className = 'time-stamp route-departure-time';
                    departureTimeDiv.textContent = `å‡ºç«™æ—¶é—´ï¼š${formatTimestamp(departureTime)}`;
                    routeStep.appendChild(departureTimeDiv);
                    
                    // ä¼ é€’è®¡ç®—çš„æ—¶é—´åˆ°buildRouteInfoå‡½æ•°
                    const routeInfoDiv = buildRouteInfo(currentRouteDetail, matchedRouteDetails, waitingTime, nonWalkRoutesCount, algorithm, lineRidingTime, lineWaitingTime);
                    routeStep.appendChild(routeInfoDiv);
                    
                    // æ˜¾ç¤ºçº¿è·¯åçš„åˆ°ç«™æ—¶é—´
                    const arrivalTimeDiv = document.createElement('div');
                    arrivalTimeDiv.className = 'time-stamp route-arrival-time';
                    arrivalTimeDiv.textContent = `åˆ°ç«™æ—¶é—´ï¼š${formatTimestamp(arrivalTime)}`;
                    routeStep.appendChild(arrivalTimeDiv);
                } else {
                    // éå®æ—¶æ¨¡å¼ï¼Œä½¿ç”¨åŸæ¥çš„æ—¶é—´è®¡ç®—
                    const routeInfoDiv = buildRouteInfo(currentRouteDetail, matchedRouteDetails, waitingTime, nonWalkRoutesCount, algorithm);
                    routeStep.appendChild(routeInfoDiv);
                }
            } else {
                // å¦‚æœæ²¡æœ‰è¯¦ç»†ä¿¡æ¯ï¼Œæ˜¾ç¤ºåŸºæœ¬è·¯çº¿ä¿¡æ¯
                const routeInfoDiv = document.createElement('div');
                routeInfoDiv.className = 'route-info';
                
                const routeTag = document.createElement('div');
                routeTag.className = 'route-tag';
                const defaultColor = '#4a90e2';
                routeTag.style.backgroundColor = defaultColor;
                
                // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
                const textColor = getContrastTextColor(defaultColor);
                routeTag.style.color = textColor;
                
                // è®¾ç½®routeTagä¸ºflexå®¹å™¨
                routeTag.style.display = 'flex';
                routeTag.style.alignItems = 'center';
                routeTag.style.justifyContent = 'space-between';
                
                // å¤„ç†è·¯çº¿ä¿¡æ¯ï¼Œåªä¿ç•™ä¸­æ–‡å’Œè‹±æ–‡ï¼Œå»é™¤æ–¹å‘å’Œåˆ†éš”ç¬¦
                let processedRouteInfo = routeInfo;
                if (processedRouteInfo.includes('||')) {
                    processedRouteInfo = processedRouteInfo.split('||')[0];
                }
                processedRouteInfo = processedRouteInfo.replace('|', ' ').trim();
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ­¥è¡Œè·¯çº¿
                const isWalk = processedRouteInfo.toLowerCase().includes('walk') || processedRouteInfo.includes('æ­¥è¡Œ');
                const icon = isWalk ? 'ğŸš¶' : 'ğŸš‚';
                const transportName = isWalk ? 'æ­¥è¡Œ' : 'åˆ—è½¦';
                
                // è·¯çº¿ä¿¡æ¯å·¦ä¾§å†…å®¹
                const routeLeftContent = document.createElement('div');
                routeLeftContent.style.display = 'flex';
                routeLeftContent.style.alignItems = 'center';
                
                // æ­¥è¡Œè·¯çº¿ä¸æ˜¾ç¤ºæ‹¬å·å†…çš„äº¤é€šç±»å‹
                if (isWalk) {
                    routeLeftContent.innerHTML = `
                        ${icon}
                        <span class="route-name">${processedRouteInfo}</span>
                    `;
                } else {
                    routeLeftContent.innerHTML = `
                        ${icon}
                        <span class="route-name">${processedRouteInfo}</span>
                        <span style="margin-left: 8px; opacity: 0.8;">(${transportName})</span>
                    `;
                }
                
                // æ·»åŠ å‰æŒ‰é’®
            const routeCloseBtn = document.createElement('button');
            routeCloseBtn.className = 'route-close-btn';
            routeCloseBtn.innerHTML = '&times;';
            routeCloseBtn.style.cssText = `
                background: none;
                border: none;
                width: auto;
                height: auto;
                cursor: pointer;
                font-size: 1rem;
                line-height: 1;
                opacity: 0.7;
                transition: color 0.2s;
                margin-left: 8px;
            `;
                
                // ç¡®ä¿æŒ‰é’®æ–‡å­—é¢œè‰²ä¸çº¿è·¯æ ‡ç­¾ä¸€è‡´
                routeCloseBtn.style.color = textColor;
                
                // æ‚¬åœæ•ˆæœ
                routeCloseBtn.addEventListener('mouseenter', function() {
                    this.style.opacity = 1;
                    this.style.color = '#ef4444';
                });
                routeCloseBtn.addEventListener('mouseleave', function() {
                    this.style.opacity = 0.7;
                    this.style.color = textColor;
                });
                
                // ç‚¹å‡»äº‹ä»¶ï¼šæ·»åŠ åˆ°ç¦è·¯çº¿
                routeCloseBtn.addEventListener('click', function() {
                    const ignoredLinesInput = document.getElementById('ignored-lines');
                    const currentValue = ignoredLinesInput.value;
                    const routeValue = processedRouteInfo;
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const lines = currentValue.split(/[,;ï¼›]/).map(line => line.trim()).filter(Boolean);
                    if (!lines.includes(routeValue)) {
                        lines.push(routeValue);
                        ignoredLinesInput.value = lines.join(';');
                        // è§¦å‘è‡ªåŠ¨è°ƒæ•´é«˜åº¦
                        if (window.autoResizeTextarea) {
                            window.autoResizeTextarea(ignoredLinesInput);
                        }
                        // æ›´æ–°ç®€ç 
                        if (typeof updateShortcode === 'function') {
                            updateShortcode();
                        }
                    }
                });
                
                // ç›´æ¥æ·»åŠ å†…å®¹åˆ°routeTag
                routeTag.appendChild(routeLeftContent);
                routeTag.appendChild(routeCloseBtn);
                routeInfoDiv.appendChild(routeTag);
                
                // åªæœ‰éæ­¥è¡Œè·¯çº¿æ‰æ˜¾ç¤ºæ–¹å‘æŒ‡ç¤ºå™¨
                if (!isWalk) {
                    const directionIndicator = document.createElement('div');
                    directionIndicator.className = 'direction-indicator';
                    directionIndicator.textContent = `å‰å¾€ ${nextStation}`;
                    routeInfoDiv.appendChild(directionIndicator);
                }
                
                // æ˜¾ç¤ºä¹˜è½¦æ—¶é•¿æˆ–æ­¥è¡Œæ—¶é—´
                const durationDiv = document.createElement('div');
                durationDiv.className = 'time-detail';
                const timeLabel = isWalk ? 'ğŸ• æ­¥è¡Œæ—¶é—´' : 'ğŸ• ä¹˜è½¦æ—¶é—´';
                durationDiv.innerHTML = `<span>${timeLabel}</span><span class="time-value">00:00</span>`;
                routeInfoDiv.appendChild(durationDiv);
                
                // åªæœ‰éæ­¥è¡Œè·¯çº¿ä¸”ä¸æ˜¯ç†è®ºæ¨¡å¼æ‰æ˜¾ç¤ºç­‰è½¦æ—¶é—´å’Œå‘è½¦é—´éš”
                if (!isWalk && algorithm !== 'theory') {
                    // æ˜¾ç¤ºç­‰è½¦æ—¶é—´
                    const waitingDiv = document.createElement('div');
                    waitingDiv.className = 'time-detail';
                    const segmentWaitingTime = nonWalkRoutesCount > 0 ? waitingTime / nonWalkRoutesCount : 0;
                    waitingDiv.innerHTML = `<span>â³ ç­‰è½¦æ—¶é—´</span><span class="time-value">${formatTime(segmentWaitingTime)}</span>`;
                    routeInfoDiv.appendChild(waitingDiv);
                    
                    // æ˜¾ç¤ºå‘è½¦é—´éš”
                    const intervalDiv = document.createElement('div');
                    intervalDiv.className = 'time-detail';
                    intervalDiv.innerHTML = `<span>â³ å‘è½¦é—´éš”</span><span class="time-value">00:00</span>`;
                    routeInfoDiv.appendChild(intervalDiv);
                }
                
                routeStep.appendChild(routeInfoDiv);
            }
            
            detailsContainer.appendChild(routeStep);
        }
        
        // 3. æ·»åŠ ç»ˆç‚¹ç«™ - å•ç‹¬æˆä¸€æ ¼
        const endStation = stationNames[stationNames.length - 1] || '';
        const endStationStep = document.createElement('div');
        endStationStep.className = 'route-step end-station';
        
        const endStationDiv = document.createElement('div');
        endStationDiv.className = 'station';
        
        // æ›¿æ¢è½¦ç«™åç§°ä¸­çš„æ‰€æœ‰ç«–æ ä¸ºç©ºæ ¼
        const formattedEndStationName = endStation.replace(/\|/g, ' ');
        endStationDiv.textContent = formattedEndStationName;
        
        endStationStep.appendChild(endStationDiv);
        detailsContainer.appendChild(endStationStep);
        
        // 4. æ·»åŠ åˆ°è¾¾æ—¶é—´æˆ³ï¼ˆä»…å®æ—¶æ¨¡å¼ï¼‰
        if (algorithm === 'real') {
            const arrivalTimeDiv = document.createElement('div');
            arrivalTimeDiv.className = 'time-stamp arrival-time';
            // ä½¿ç”¨æœ€åä¸€æ¡è·¯çº¿çš„åˆ°ç«™æ—¶é—´ä½œä¸ºæ€»åˆ°è¾¾æ—¶é—´
            const arrivalTime = routeDetails.length > 0 ? routeDetails[routeDetails.length - 1][6] : 0;
            arrivalTimeDiv.textContent = `åˆ°è¾¾æ—¶é—´: ${formatTimestamp(arrivalTime)}`;
            detailsContainer.appendChild(arrivalTimeDiv);
        }
    }
    
    // æ ¼å¼åŒ–æ—¶é—´å‡½æ•° (ç§’è½¬ h:mm:ss æˆ– mm:ss)
    function formatTime(seconds) {
        // ç¡®ä¿secondsæ˜¯æ•°å­—ç±»å‹
        const totalSeconds = Math.round(Number(seconds) || 0);
        
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const remainingSeconds = totalSeconds % 60;
        
        if (hours > 0) {
            // è¶…è¿‡ä¸€å°æ—¶ï¼Œæ˜¾ç¤º h:mm:ss
            return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        } else {
            // ä¸è¶³ä¸€å°æ—¶ï¼Œæ˜¾ç¤º mm:ss
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    }
    
    // è·å–äº¤é€šå›¾æ ‡
    function getTransportIcon(trainType) {
        const iconMap = {
            'train_normal': 'ğŸš‚',
            'train_high_speed': 'ğŸš…',
            'train_light_rail': 'ğŸš‹',
            'boat_normal': 'ğŸš¢',
            'boat_light_rail': 'â›´ï¸',
            'boat_high_speed': 'ğŸš¤',
            'cable_car_normal': 'ğŸš¡',
            'airplane_normal': 'âœˆï¸',
            'walk': 'ğŸš¶'
        };
        return iconMap[trainType] || 'ğŸš‚';
    }
    
    // è·å–äº¤é€šç±»å‹åç§°
    function getTransportName(trainType) {
        const nameMap = {
            'train_normal': 'æ™®é€šåˆ—è½¦',
            'train_high_speed': 'é«˜é€Ÿåˆ—è½¦',
            'train_light_rail': 'è½»è½¨',
            'boat_normal': 'æ™®é€šèˆ¹',
            'boat_light_rail': 'è½»è½¨èˆ¹',
            'boat_high_speed': 'é«˜é€Ÿèˆ¹',
            'cable_car_normal': 'ç¼†è½¦',
            'airplane_normal': 'é£æœº',
            'walk': 'æ­¥è¡Œ'
        };
        return nameMap[trainType] || 'åˆ—è½¦';
    }
    
    // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
    function getContrastTextColor(hexColor) {
        // è§£æåå…­è¿›åˆ¶é¢œè‰²å€¼
        const hex = hexColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        
        // è®¡ç®—äº®åº¦ (luminance)
        // ä½¿ç”¨æ ‡å‡†çš„ç›¸å¯¹äº®åº¦å…¬å¼
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        
        // å¦‚æœäº®åº¦å°äº0.5ï¼Œä½¿ç”¨ç™½è‰²æ–‡å­—ï¼Œå¦åˆ™ä½¿ç”¨é»‘è‰²æ–‡å­—
        return luminance < 0.5 ? 'white' : 'black';
    }
</script>
{% endblock %}