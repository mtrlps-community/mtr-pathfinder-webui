{% extends 'base.html' %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- å·¦ä¾§ï¼šå¯»è·¯è¡¨å• -->
    <div class="lg:col-span-1">
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">è·¯å¾„æŸ¥æ‰¾</h2>
            
            <form id="route-form">
                <!-- èµ·ç‚¹ç«™ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="start-station">
                        <i class="fa fa-map-marker mr-1"></i> èµ·ç‚¹ç«™
                    </label>
                    <div class="relative">
                        <input type="text" id="start-station" name="start" 
                               class="form-input" placeholder="è¾“å…¥èµ·ç‚¹ç«™åç§°" required>
                        <div id="start-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden"></div>
                    </div>
                </div>
                
                <!-- ç»ˆç‚¹ç«™ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="end-station">
                        <i class="fa fa-flag mr-1"></i> ç»ˆç‚¹ç«™
                    </label>
                    <div class="relative">
                        <input type="text" id="end-station" name="end" 
                               class="form-input" placeholder="è¾“å…¥ç»ˆç‚¹ç«™åç§°" required>
                        <div id="end-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden"></div>
                    </div>
                </div>
                
                <!-- ç¦è·¯çº¿ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="ignored-lines">
                        <i class="fa fa-ban mr-1"></i> ç¦è·¯çº¿ï¼ˆé€—å·åˆ†éš”ï¼‰
                    </label>
                    <input type="text" id="ignored-lines" name="ignored_lines" 
                           class="form-input" placeholder="è¾“å…¥è¦ç¦æ­¢çš„è·¯çº¿ï¼Œä»¥é€—å·åˆ†éš”">
                </div>
                
                <!-- ç¦è½¦ç«™ -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2" for="avoid-stations">
                        <i class="fa fa-ban mr-1"></i> ç¦è½¦ç«™ï¼ˆé€—å·åˆ†éš”ï¼‰
                    </label>
                    <input type="text" id="avoid-stations" name="avoid_stations" 
                           class="form-input" placeholder="è¾“å…¥è¦é¿å¼€çš„è½¦ç«™ï¼Œä»¥é€—å·åˆ†éš”">
                </div>
                
                <!-- å¯»è·¯è®¾ç½® -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">å¯»è·¯è®¾ç½®</h3>
                    
                    <div class="route-settings flex flex-wrap gap-4">
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="disable-high-speed" name="disable_high_speed" class="form-checkbox">
                            <span class="ml-2 text-gray-700">ç¦é«˜é“</span>
                        </label>
                        
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="disable-boat" name="disable_boat" class="form-checkbox">
                            <span class="ml-2 text-gray-700">ç¦èˆ¹</span>
                        </label>
                        
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="enable-wild" name="enable_wild" class="form-checkbox">
                            <span class="ml-2 text-gray-700">è¶Šé‡</span>
                        </label>
                        
                        <label class="flex items-center p-2 bg-gray-100 rounded-md cursor-pointer hover:bg-gray-200 transition-colors">
                            <input type="checkbox" id="only-lrt" name="only_lrt" class="form-checkbox">
                            <span class="ml-2 text-gray-700">ä»…è½»è½¨</span>
                        </label>
                    </div>
                </div>
                
                <!-- å¯»è·¯ç®—æ³•é€‰æ‹© -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">å¯»è·¯ç®—æ³•</h3>
                    
                    <div class="algorithm-tabs">
                        <div class="flex overflow-x-auto no-scrollbar">
                            <div class="algorithm-tab active" data-index="0" data-value="default">é»˜è®¤</div>
                            <div class="algorithm-tab" data-index="1" data-value="theory">ç†è®º</div>
                            <div class="algorithm-tab" data-index="2" data-value="real">å®æ—¶</div>
                            <div class="algorithm-tab" data-index="3" data-value="real_v4">å®æ—¶[v4]</div>
                        </div>
                        <div class="mt-2 text-center font-medium text-blue-500" id="algorithm-display">é»˜è®¤ï¼ˆè€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰</div>
                        <input type="hidden" id="algorithm" name="algorithm" value="default">
                    </div>
                </div>
                
                <!-- æŸ¥æ‰¾æŒ‰é’® -->
                <div class="flex space-x-3">
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fa fa-search mr-2"></i> æŸ¥æ‰¾è·¯å¾„
                    </button>
                    <button type="reset" class="btn-secondary">
                        <i class="fa fa-refresh mr-2"></i> é‡ç½®
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- å³ä¾§ï¼šç»“æœå±•ç¤º -->
    <div class="lg:col-span-2">
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">è·¯å¾„ç»“æœ</h2>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                <p class="mt-4 text-gray-600">æ­£åœ¨è®¡ç®—è·¯å¾„...</p>
            </div>
            
            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4"></div>
            
            <!-- ç»“æœåŒºåŸŸ -->
            <div id="result" class="hidden">
                <!-- è¯¦ç»†è·¯å¾„ -->
                <div id="route-details" class="space-y-4">
                    <!-- è·¯å¾„æ­¥éª¤å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- ç»“æœå›¾åƒ -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3">è·¯å¾„å›¾åƒ</h3>
                    <div id="route-image" class="border border-gray-300 rounded-lg p-4 bg-white">
                        <p class="text-gray-500 text-center">è·¯å¾„å›¾åƒå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                </div>
            </div>
            
            <!-- æ— ç»“æœçŠ¶æ€ -->
            <div id="no-result" class="hidden text-center py-12">
                <i class="fa fa-route text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">æœªæ‰¾åˆ°è·¯å¾„</h3>
                <p class="text-gray-500">è¯·æ£€æŸ¥è¾“å…¥å‚æ•°æˆ–å°è¯•å…¶ä»–ç®—æ³•</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ç®—æ³•æ˜ å°„
    const algorithmMap = [
        { value: 'default', label: 'é»˜è®¤ï¼ˆè€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰' },
        { value: 'theory', label: 'ç†è®ºï¼ˆä¸è€ƒè™‘ç­‰è½¦æ—¶é—´ï¼‰' },
        { value: 'real', label: 'å®æ—¶' },
        { value: 'real_v4', label: 'å®æ—¶[v4]ï¼ˆCSAç®—æ³•ï¼‰' }
    ];
    
    // ç®—æ³•é€‰é¡¹å¡å¤„ç†
    const algorithmTabs = document.querySelectorAll('.algorithm-tab');
    const algorithmDisplay = document.getElementById('algorithm-display');
    const algorithmInput = document.getElementById('algorithm');
    
    algorithmTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡çš„activeç±»
            algorithmTabs.forEach(t => t.classList.remove('active'));
            
            // æ·»åŠ å½“å‰é€‰é¡¹å¡çš„activeç±»
            this.classList.add('active');
            
            // æ›´æ–°ç®—æ³•æ˜¾ç¤ºå’Œéšè—è¾“å…¥
            const index = parseInt(this.dataset.index);
            algorithmDisplay.textContent = algorithmMap[index].label;
            algorithmInput.value = algorithmMap[index].value;
        });
    });
    
    // è½¦ç«™æ¨¡ç³Šæœç´¢
    function setupStationSearch(inputId, suggestionsId) {
        const input = document.getElementById(inputId);
        const suggestions = document.getElementById(suggestionsId);
        
        input.addEventListener('input', async function() {
            const query = this.value.trim();
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch(`/api/search_stations?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                suggestions.innerHTML = '';
                if (data.length > 0) {
                    data.forEach(station => {
                        const div = document.createElement('div');
                        div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        div.textContent = station;
                        div.addEventListener('click', () => {
                            input.value = station;
                            suggestions.classList.add('hidden');
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.classList.remove('hidden');
                } else {
                    suggestions.classList.add('hidden');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                suggestions.classList.add('hidden');
            }
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­å»ºè®®åˆ—è¡¨
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
        });
    }
    
    setupStationSearch('start-station', 'start-suggestions');
    setupStationSearch('end-station', 'end-suggestions');
    
    // è¡¨å•æäº¤å¤„ç†
    const routeForm = document.getElementById('route-form');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const result = document.getElementById('result');
    const noResult = document.getElementById('no-result');
    
    routeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        loading.classList.remove('hidden');
        error.classList.add('hidden');
        result.classList.add('hidden');
        noResult.classList.add('hidden');
        
        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = new FormData(routeForm);
        const data = {
            start: formData.get('start'),
            end: formData.get('end'),
            ignored_lines: formData.get('ignored_lines').split(',').map(s => s.trim()).filter(Boolean),
            avoid_stations: formData.get('avoid_stations').split(',').map(s => s.trim()).filter(Boolean),
            disable_high_speed: formData.get('disable_high_speed') === 'on',
            disable_boat: formData.get('disable_boat') === 'on',
            enable_wild: formData.get('enable_wild') === 'on',
            only_lrt: formData.get('only_lrt') === 'on',
            algorithm: formData.get('algorithm')
        };
        
        try {
            // å‘é€è¯·æ±‚
            const response = await fetch('/api/find_route', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const resultData = await response.json();
            
            if (response.ok) {
                if (resultData.result) {
                    // æ˜¾ç¤ºç»“æœ
                    displayResult(resultData.result);
                } else {
                    // æ— ç»“æœ
                    noResult.classList.remove('hidden');
                }
            } else {
                // æ˜¾ç¤ºé”™è¯¯
                error.textContent = resultData.error || 'å¯»è·¯å¤±è´¥';
                error.classList.remove('hidden');
            }
        } catch (err) {
            // æ˜¾ç¤ºé”™è¯¯
            error.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            error.classList.remove('hidden');
            console.error('å¯»è·¯é”™è¯¯:', err);
        } finally {
            // éšè—åŠ è½½çŠ¶æ€
            loading.classList.add('hidden');
        }
    });
    
    // æ˜¾ç¤ºç»“æœ
    function displayResult(routeResult) {
        result.classList.remove('hidden');
        
        // è§£ærouteresultæ•°ç»„ï¼Œæ·»åŠ é»˜è®¤å€¼å¤„ç†
        const totalTime = routeResult[3] || 0; // æ€»ç”¨æ—¶ (å…ƒç´ 3, ç§’)
        const travelingTime = routeResult[7] || 0; // ä¹˜è½¦æ—¶é—´ (å…ƒç´ 7, ç§’)
        const waitingTime = routeResult[8] || 0; // ç­‰è½¦æ—¶é—´ (å…ƒç´ 8, ç§’)
        
        // ç¡®ä¿stationNamesæ˜¯æ•°ç»„
        const stationNames = Array.isArray(routeResult[4]) ? routeResult[4] : [];
        
        // ç¡®ä¿routeDetailsæ˜¯æ•°ç»„ï¼Œé¿å…TypeError
        const routeDetails = Array.isArray(routeResult[6]) ? routeResult[6] : [];
        
        // æ¸…ç©ºç°æœ‰å†…å®¹
        const detailsContainer = document.getElementById('route-details');
        detailsContainer.innerHTML = '';
        
        // 1. åˆ›å»ºæ—¶é—´ä¿¡æ¯éƒ¨åˆ†
        const timeInfoDiv = document.createElement('div');
        timeInfoDiv.className = 'time-info';
        timeInfoDiv.id = 'time-info';
        timeInfoDiv.innerHTML = `
            <h3>è·¯çº¿æ¦‚è§ˆ</h3>
            <div class="time-grid">
                <div class="time-item">
                    <strong id="total-time">${formatTime(totalTime)}</strong>
                    <span>æ€»ç”¨æ—¶</span>
                </div>
                <div class="time-item">
                    <strong id="traveling-time">${formatTime(travelingTime)}</strong>
                    <span>ä¹˜è½¦æ—¶é—´</span>
                </div>
                <div class="time-item">
                    <strong id="waiting-time">${formatTime(waitingTime)}</strong>
                    <span>ç­‰è½¦æ—¶é—´</span>
                </div>
            </div>
        `;
        detailsContainer.appendChild(timeInfoDiv);
        
        // 2. å¤„ç†è·¯çº¿æ­¥éª¤ï¼Œç¡®ä¿stationNamesæœ‰è¶³å¤Ÿå…ƒç´ 
        if (stationNames.length < 2) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = 'è·¯çº¿æ•°æ®ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–ç¨åé‡è¯•ã€‚';
            detailsContainer.appendChild(errorDiv);
            return;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ‡å‡†åŒ–è½¦ç«™åç§°ï¼Œç”¨äºåŒ¹é…æ¯”è¾ƒ
        function normalizeStationName(name) {
            if (typeof name === 'string') {
                // æ›¿æ¢æ‰€æœ‰åˆ†éš”ç¬¦ä¸ºç©ºæ ¼ï¼Œç„¶åå»é™¤å¤šä½™ç©ºæ ¼
                return name.replace(/[|]/g, ' ').trim().toLowerCase();
            }
            return name;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†ç»ˆç‚¹ç«™åç§°ï¼Œå°† | æ›¿æ¢ä¸ºç©ºæ ¼
        function formatTerminusName(name) {
            if (typeof name === 'string') {
                return name.replace('|', ' ').trim();
            }
            return name;
        }
        
        // å‡½æ•°ï¼šé‡æ–°è®¡ç®—å¹¶æ›´æ–°æ€»ç”¨æ—¶
        function updateTotalTime() {
            let totalTravelingTime = 0;
            let totalWaitingTime = 0;
            
            // è·å–æ‰€æœ‰è·¯çº¿ä¿¡æ¯å…ƒç´ 
            const routeInfoElements = document.querySelectorAll('.route-info');
            
            // éå†æ¯ä¸ªè·¯çº¿ä¿¡æ¯
            routeInfoElements.forEach(routeInfo => {
                // æå–ä¹˜è½¦æ—¶é—´æˆ–æ­¥è¡Œæ—¶é—´
                const timeDetails = routeInfo.querySelectorAll('.time-detail');
                timeDetails.forEach(detail => {
                    const timeValue = detail.querySelector('.time-value');
                    if (timeValue) {
                        const timeText = timeValue.textContent;
                        const seconds = parseTimeString(timeText);
                        
                        // åˆ¤æ–­æ˜¯ä¹˜è½¦æ—¶é—´è¿˜æ˜¯å‘è½¦é—´éš”
                        if (detail.textContent.includes('ä¹˜è½¦æ—¶é—´') || detail.textContent.includes('æ­¥è¡Œæ—¶é—´')) {
                            totalTravelingTime += seconds;
                        } else if (detail.textContent.includes('å‘è½¦é—´éš”')) {
                            totalWaitingTime += seconds;
                        }
                    }
                });
            });
            
            // è®¡ç®—æ€»ç”¨æ—¶
            const totalTime = totalTravelingTime + totalWaitingTime;
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            document.getElementById('total-time').textContent = formatTime(totalTime);
            document.getElementById('traveling-time').textContent = formatTime(totalTravelingTime);
            document.getElementById('waiting-time').textContent = formatTime(totalWaitingTime);
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºç§’æ•°
        function parseTimeString(timeStr) {
            const parts = timeStr.split(':');
            let seconds = 0;
            
            if (parts.length === 3) {
                // h:mm:ss
                seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
            } else if (parts.length === 2) {
                // mm:ss
                seconds = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            
            return seconds;
        }
        
        // å‡½æ•°ï¼šæ„å»ºè·¯çº¿ä¿¡æ¯
        function buildRouteInfo(routeDetail, matchedRouteDetails) {
            const routeInfoDiv = document.createElement('div');
            routeInfoDiv.className = 'route-info';
            
            // è§£æè·¯çº¿è¯¦ç»†ä¿¡æ¯ï¼Œæ·»åŠ é»˜è®¤å€¼
            const [, , color = '#4a90e2', routeName = '', terminus = '', duration = 0, interval = 0, , trainType = 'train_normal'] = routeDetail;
            
            // å¤„ç†è·¯çº¿åç§°ï¼Œåªä¿ç•™ä¸­æ–‡å’Œè‹±æ–‡ï¼Œå»é™¤æ–¹å‘å’Œåˆ†éš”ç¬¦
            // åŸå§‹æ ¼å¼ï¼š"åœ°éµå—å¤§é™¸ç¶«åŒ—æ®µ|Metro South Continental Line N. Section||to New Red Leaves"
            // ç›®æ ‡æ ¼å¼ï¼š"åœ°éµå—å¤§é™¸ç¶«åŒ—æ®µ Metro South Continental Line N. Section"
            let processedRouteName = routeName;
            if (processedRouteName.includes('||')) {
                processedRouteName = processedRouteName.split('||')[0];
            }
            processedRouteName = processedRouteName.replace('|', ' ').trim();
            
            // åˆ›å»ºè·¯çº¿æ ‡ç­¾ï¼Œä½¿ç”¨æ­£ç¡®çš„é¢œè‰²
            const routeTag = document.createElement('div');
            routeTag.className = 'route-tag';
            routeTag.style.backgroundColor = color;
            
            // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
            const textColor = getContrastTextColor(color);
            routeTag.style.color = textColor;
            
            // è·å–äº¤é€šå›¾æ ‡
            const transportIcon = getTransportIcon(trainType);
            const transportName = getTransportName(trainType);
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ­¥è¡Œè·¯çº¿
            const isWalk = trainType === 'walk' || processedRouteName.toLowerCase().includes('walk') || processedRouteName.includes('æ­¥è¡Œ');
            
            // æ­¥è¡Œè·¯çº¿ä¸æ˜¾ç¤ºæ‹¬å·å†…çš„äº¤é€šç±»å‹
            if (isWalk) {
                routeTag.innerHTML = `
                    ${transportIcon}
                    <span class="route-name">${processedRouteName}</span>
                `;
            } else {
                routeTag.innerHTML = `
                    ${transportIcon}
                    <span class="route-name">${processedRouteName}</span>
                    <span style="margin-left: 8px; opacity: 0.8;">(${transportName})</span>
                `;
            }
            routeInfoDiv.appendChild(routeTag);
            
            // åªæœ‰éæ­¥è¡Œè·¯çº¿æ‰æ˜¾ç¤ºæ–¹å‘æŒ‡ç¤ºå™¨
            if (!isWalk) {
                // æ˜¾ç¤ºæ–¹å‘æŒ‡ç¤ºå™¨ï¼ˆç»ˆç‚¹ç«™ï¼‰
                // terminus çš„æ ¼å¼å¯èƒ½æ˜¯ï¼š
                //   - æ™®é€šè·¯çº¿ï¼š("ç»ˆç‚¹ç«™ä¸­æ–‡", "ç»ˆç‚¹ç«™è‹±æ–‡") å…ƒç»„
                //   - ç¯çº¿ï¼š(true, "ç¯çº¿ä¸­æ–‡", "ç¯çº¿è‹±æ–‡") å…ƒç»„
                //   - å­—ç¬¦ä¸²æ ¼å¼
                const directionIndicator = document.createElement('div');
                directionIndicator.className = 'direction-indicator';
                
                let terminusDisplay = '';
                
                // åœ¨JavaScriptä¸­ï¼ŒPythonå…ƒç»„ä¼šè¢«è½¬æ¢ä¸ºæ•°ç»„ï¼Œæ‰€ä»¥ç›´æ¥æ£€æŸ¥æ˜¯å¦ä¸ºæ•°ç»„
                if (Array.isArray(terminus)) {
                    if (terminus.length >= 2) {
                        if (terminus[0] === true && terminus.length >= 3) {
                            // ç¯çº¿æ ¼å¼ï¼š[true, "ç¯çº¿ä¸­æ–‡", "ç¯çº¿è‹±æ–‡"]
                            const terminus1 = formatTerminusName(terminus[1]);
                            const terminus2 = formatTerminusName(terminus[2]);
                            // ç›´æ¥æ˜¾ç¤ºç¯çº¿ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        } else {
                            // æ™®é€šè·¯çº¿ï¼š["ç»ˆç‚¹ç«™ä¸­æ–‡", "ç»ˆç‚¹ç«™è‹±æ–‡"]
                            const terminus1 = formatTerminusName(terminus[0]);
                            const terminus2 = formatTerminusName(terminus[1]);
                            // ç›´æ¥æ˜¾ç¤ºç»ˆç‚¹ç«™ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        }
                    }
                } else if (typeof terminus === 'object' && terminus !== null) {
                    // å¤„ç†å¯¹è±¡æ ¼å¼ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    const keys = Object.keys(terminus);
                    if (keys.length >= 2) {
                        if (terminus[0] === true && keys.length >= 3) {
                            // ç¯çº¿æ ¼å¼ï¼š{0: true, 1: "ç¯çº¿ä¸­æ–‡", 2: "ç¯çº¿è‹±æ–‡"}
                            const terminus1 = formatTerminusName(terminus[1]);
                            const terminus2 = formatTerminusName(terminus[2]);
                            // ç›´æ¥æ˜¾ç¤ºç¯çº¿ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        } else {
                            // æ™®é€šè·¯çº¿ï¼š{0: "ç»ˆç‚¹ç«™ä¸­æ–‡", 1: "ç»ˆç‚¹ç«™è‹±æ–‡"}
                            const terminus1 = formatTerminusName(terminus[0]);
                            const terminus2 = formatTerminusName(terminus[1]);
                            // ç›´æ¥æ˜¾ç¤ºç»ˆç‚¹ç«™ä¿¡æ¯ï¼Œä¸­è‹±æ–‡ä¹‹é—´ç©ºä¸€æ ¼
                            terminusDisplay = `${terminus1} ${terminus2}`;
                        }
                    }
                } else if (typeof terminus === 'string') {
                    // å­—ç¬¦ä¸²æ ¼å¼ï¼Œå¯èƒ½åŒ…å« | åˆ†éš”ç¬¦
                    const formattedTerminus = formatTerminusName(terminus);
                    // ç›´æ¥æ˜¾ç¤ºç»ˆç‚¹ç«™ä¿¡æ¯
                    terminusDisplay = formattedTerminus;
                }
                
                directionIndicator.textContent = terminusDisplay;
                routeInfoDiv.appendChild(directionIndicator);
            }
            
            // æ˜¾ç¤ºä¹˜è½¦æ—¶é•¿æˆ–æ­¥è¡Œæ—¶é—´
            const durationDiv = document.createElement('div');
            durationDiv.className = 'time-detail';
            const timeLabel = isWalk ? 'ğŸ• æ­¥è¡Œæ—¶é—´' : 'ğŸ• ä¹˜è½¦æ—¶é—´';
            durationDiv.innerHTML = `<span>${timeLabel}</span><span class="time-value">${formatTime(duration)}</span>`;
            routeInfoDiv.appendChild(durationDiv);
            
            // åªæœ‰éæ­¥è¡Œè·¯çº¿æ‰æ˜¾ç¤ºå‘è½¦é—´éš”
            if (!isWalk) {
                const intervalDiv = document.createElement('div');
                intervalDiv.className = 'time-detail';
                intervalDiv.innerHTML = `<span>â³ å‘è½¦é—´éš”</span><span class="time-value">${formatTime(interval)}</span>`;
                routeInfoDiv.appendChild(intervalDiv);
            }
            
            // å¦‚æœæœ‰å…¶ä»–åŒ¹é…çš„è·¯çº¿ï¼Œæ˜¾ç¤º"æˆ–"é€‰é¡¹
            if (matchedRouteDetails.length > 1) {
                const otherRoutesDiv = document.createElement('div');
                otherRoutesDiv.className = 'other-routes';
                otherRoutesDiv.innerHTML = '<div class="other-routes-label">æˆ–</div>';
                
                const otherRoutesList = document.createElement('div');
                otherRoutesList.className = 'other-routes-list';
                
                // éå†å…¶ä»–åŒ¹é…çš„è·¯çº¿
                for (let j = 0; j < matchedRouteDetails.length; j++) {
                    // è·³è¿‡å½“å‰æ˜¾ç¤ºçš„è·¯çº¿
                    if (matchedRouteDetails[j] === routeDetail) {
                        continue;
                    }
                    
                    const otherRoute = matchedRouteDetails[j];
                    const [, , otherColor = '#4a90e2', otherRouteName = '', , otherDuration = 0, otherInterval = 0, , otherTrainType = 'train_normal'] = otherRoute;
                    
                    // å¤„ç†å…¶ä»–è·¯çº¿åç§°
                    let processedOtherRouteName = otherRouteName;
                    if (processedOtherRouteName.includes('||')) {
                        processedOtherRouteName = processedOtherRouteName.split('||')[0];
                    }
                    processedOtherRouteName = processedOtherRouteName.replace('|', ' ').trim();
                    
                    // åˆ›å»ºå…¶ä»–è·¯çº¿æ ‡ç­¾
                    const otherRouteTag = document.createElement('div');
                    otherRouteTag.className = 'other-route-tag';
                    otherRouteTag.style.backgroundColor = otherColor;
                    
                    // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
                    const otherTextColor = getContrastTextColor(otherColor);
                    otherRouteTag.style.color = otherTextColor;
                    
                    // è·å–äº¤é€šå›¾æ ‡
                    const otherTransportIcon = getTransportIcon(otherTrainType);
                    const otherTransportName = getTransportName(otherTrainType);
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæ­¥è¡Œè·¯çº¿
                    const otherIsWalk = otherTrainType === 'walk' || processedOtherRouteName.toLowerCase().includes('walk') || processedOtherRouteName.includes('æ­¥è¡Œ');
                    
                    // æ­¥è¡Œè·¯çº¿ä¸æ˜¾ç¤ºæ‹¬å·å†…çš„äº¤é€šç±»å‹
                    if (otherIsWalk) {
                        otherRouteTag.innerHTML = `
                            ${otherTransportIcon}
                            <span class="other-route-name">${processedOtherRouteName}</span>
                        `;
                    } else {
                        otherRouteTag.innerHTML = `
                            ${otherTransportIcon}
                            <span class="other-route-name">${processedOtherRouteName}</span>
                            <span style="margin-left: 4px; opacity: 0.8; font-size: 0.85em;">(${otherTransportName})</span>
                        `;
                    }
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    otherRouteTag.addEventListener('click', function() {
                        // é‡æ–°æ„å»ºè·¯çº¿ä¿¡æ¯
                        const newRouteInfo = buildRouteInfo(otherRoute, matchedRouteDetails);
                        // æ›¿æ¢å½“å‰è·¯çº¿ä¿¡æ¯
                        routeInfoDiv.parentNode.replaceChild(newRouteInfo, routeInfoDiv);
                        // æ›´æ–°æ€»ç”¨æ—¶
                        updateTotalTime();
                    });
                    
                    otherRoutesList.appendChild(otherRouteTag);
                }
                
                otherRoutesDiv.appendChild(otherRoutesList);
                routeInfoDiv.appendChild(otherRoutesDiv);
            }
            
            return routeInfoDiv;
        }
        
        for (let i = 0; i < stationNames.length - 1; i += 2) {
            const currentStation = stationNames[i] || '';
            const routeInfo = stationNames[i + 1] || '';
            const nextStation = stationNames[i + 2] || stationNames[stationNames.length - 1] || '';
            
            // æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„è¯¦ç»†è·¯çº¿ä¿¡æ¯
            let matchedRouteDetails = [];
            
            for (const detail of routeDetails) {
                if (Array.isArray(detail)) {
                    const detailStart = detail[0] || '';
                    const detailEnd = detail[1] || '';
                    
                    // ä½¿ç”¨æ ‡å‡†åŒ–åç§°è¿›è¡ŒåŒ¹é…
                    if (normalizeStationName(detailStart) === normalizeStationName(currentStation) && 
                        normalizeStationName(detailEnd) === normalizeStationName(nextStation)) {
                        matchedRouteDetails.push(detail);
                    }
                }
            }
            
            // 1. æ˜¾ç¤ºå½“å‰è½¦ç«™åç§° - å•ç‹¬æˆä¸€æ ¼
            const stationStep = document.createElement('div');
            stationStep.className = `route-step ${i === 0 ? 'start-station' : ''}`;
            
            const stationDiv = document.createElement('div');
            stationDiv.className = 'station';
            
            // æ›¿æ¢è½¦ç«™åç§°ä¸­çš„æ‰€æœ‰ç«–æ ä¸ºç©ºæ ¼
            const formattedStationName = currentStation.replace(/\|/g, ' ');
            stationDiv.textContent = formattedStationName;
            
            stationStep.appendChild(stationDiv);
            detailsContainer.appendChild(stationStep);
            
            // 2. åˆ›å»ºè·¯çº¿æ­¥éª¤å®¹å™¨ - åªåŒ…å«è·¯çº¿ä¿¡æ¯
            const routeStep = document.createElement('div');
            routeStep.className = 'route-step';
            
            if (matchedRouteDetails.length > 0) {
                // æ˜¾ç¤ºç¬¬ä¸€ç§è·¯çº¿çš„è¯¦ç»†ä¿¡æ¯
                const currentRouteDetail = matchedRouteDetails[0];
                const routeInfoDiv = buildRouteInfo(currentRouteDetail, matchedRouteDetails);
                routeStep.appendChild(routeInfoDiv);
            } else {
                // å¦‚æœæ²¡æœ‰è¯¦ç»†ä¿¡æ¯ï¼Œæ˜¾ç¤ºåŸºæœ¬è·¯çº¿ä¿¡æ¯
                const routeInfoDiv = document.createElement('div');
                routeInfoDiv.className = 'route-info';
                
                const routeTag = document.createElement('div');
                routeTag.className = 'route-tag';
                const defaultColor = '#4a90e2';
                routeTag.style.backgroundColor = defaultColor;
                
                // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
                const textColor = getContrastTextColor(defaultColor);
                routeTag.style.color = textColor;
                
                // å¤„ç†è·¯çº¿ä¿¡æ¯ï¼Œåªä¿ç•™ä¸­æ–‡å’Œè‹±æ–‡ï¼Œå»é™¤æ–¹å‘å’Œåˆ†éš”ç¬¦
                let processedRouteInfo = routeInfo;
                if (processedRouteInfo.includes('||')) {
                    processedRouteInfo = processedRouteInfo.split('||')[0];
                }
                processedRouteInfo = processedRouteInfo.replace('|', ' ').trim();
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ­¥è¡Œè·¯çº¿
                const isWalk = processedRouteInfo.toLowerCase().includes('walk') || processedRouteInfo.includes('æ­¥è¡Œ');
                const icon = isWalk ? 'ğŸš¶' : 'ğŸš‚';
                const transportName = isWalk ? 'æ­¥è¡Œ' : 'åˆ—è½¦';
                
                // æ­¥è¡Œè·¯çº¿ä¸æ˜¾ç¤ºæ‹¬å·å†…çš„äº¤é€šç±»å‹
                if (isWalk) {
                    routeTag.innerHTML = `
                        ${icon}
                        <span class="route-name">${processedRouteInfo}</span>
                    `;
                } else {
                    routeTag.innerHTML = `
                        ${icon}
                        <span class="route-name">${processedRouteInfo}</span>
                        <span style="margin-left: 8px; opacity: 0.8;">(${transportName})</span>
                    `;
                }
                routeInfoDiv.appendChild(routeTag);
                
                // åªæœ‰éæ­¥è¡Œè·¯çº¿æ‰æ˜¾ç¤ºæ–¹å‘æŒ‡ç¤ºå™¨
                if (!isWalk) {
                    const directionIndicator = document.createElement('div');
                    directionIndicator.className = 'direction-indicator';
                    directionIndicator.textContent = `å‰å¾€ ${nextStation}`;
                    routeInfoDiv.appendChild(directionIndicator);
                }
                
                routeStep.appendChild(routeInfoDiv);
            }
            
            detailsContainer.appendChild(routeStep);
        }
        
        // 3. æ·»åŠ ç»ˆç‚¹ç«™ - å•ç‹¬æˆä¸€æ ¼
        const endStation = stationNames[stationNames.length - 1] || '';
        const endStationStep = document.createElement('div');
        endStationStep.className = 'route-step end-station';
        
        const endStationDiv = document.createElement('div');
        endStationDiv.className = 'station';
        
        // æ›¿æ¢è½¦ç«™åç§°ä¸­çš„æ‰€æœ‰ç«–æ ä¸ºç©ºæ ¼
        const formattedEndStationName = endStation.replace(/\|/g, ' ');
        endStationDiv.textContent = formattedEndStationName;
        
        endStationStep.appendChild(endStationDiv);
        detailsContainer.appendChild(endStationStep);
    }
    
    // æ ¼å¼åŒ–æ—¶é—´å‡½æ•° (ç§’è½¬ h:mm:ss æˆ– mm:ss)
    function formatTime(seconds) {
        // ç¡®ä¿secondsæ˜¯æ•°å­—ç±»å‹
        const totalSeconds = Math.round(Number(seconds) || 0);
        
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const remainingSeconds = totalSeconds % 60;
        
        if (hours > 0) {
            // è¶…è¿‡ä¸€å°æ—¶ï¼Œæ˜¾ç¤º h:mm:ss
            return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        } else {
            // ä¸è¶³ä¸€å°æ—¶ï¼Œæ˜¾ç¤º mm:ss
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
    }
    
    // è·å–äº¤é€šå›¾æ ‡
    function getTransportIcon(trainType) {
        const iconMap = {
            'train_normal': 'ğŸš‚',
            'train_high_speed': 'ğŸš…',
            'train_light_rail': 'ğŸš‹',
            'boat_normal': 'ğŸš¢',
            'boat_light_rail': 'â›´ï¸',
            'boat_high_speed': 'ğŸš¤',
            'cable_car_normal': 'ğŸš¡',
            'airplane_normal': 'âœˆï¸',
            'walk': 'ğŸš¶'
        };
        return iconMap[trainType] || 'ğŸš‚';
    }
    
    // è·å–äº¤é€šç±»å‹åç§°
    function getTransportName(trainType) {
        const nameMap = {
            'train_normal': 'æ™®é€šåˆ—è½¦',
            'train_high_speed': 'é«˜é€Ÿåˆ—è½¦',
            'train_light_rail': 'è½»è½¨',
            'boat_normal': 'æ™®é€šèˆ¹',
            'boat_light_rail': 'è½»è½¨èˆ¹',
            'boat_high_speed': 'é«˜é€Ÿèˆ¹',
            'cable_car_normal': 'ç¼†è½¦',
            'airplane_normal': 'é£æœº',
            'walk': 'æ­¥è¡Œ'
        };
        return nameMap[trainType] || 'åˆ—è½¦';
    }
    
    // æ ¹æ®èƒŒæ™¯è‰²è‡ªåŠ¨è®¡ç®—æ–‡å­—é¢œè‰²
    function getContrastTextColor(hexColor) {
        // è§£æåå…­è¿›åˆ¶é¢œè‰²å€¼
        const hex = hexColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        
        // è®¡ç®—äº®åº¦ (luminance)
        // ä½¿ç”¨æ ‡å‡†çš„ç›¸å¯¹äº®åº¦å…¬å¼
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        
        // å¦‚æœäº®åº¦å°äº0.5ï¼Œä½¿ç”¨ç™½è‰²æ–‡å­—ï¼Œå¦åˆ™ä½¿ç”¨é»‘è‰²æ–‡å­—
        return luminance < 0.5 ? 'white' : 'black';
    }
</script>
{% endblock %}